# Анализ битовых масок и сжатия данных для ClickHouse

## Обзор структуры MD_Components.xlsx

Файл содержит **30 записей** о компонентах вертолетов с **26 уникальными типами** компонентов. Структура:
- **Строка 7**: Русские названия столбцов  
- **Строка 8**: Английские названия полей (используется как header)
- **Строки 9+**: Данные компонентов

## 1. Битовые маски применимости (effectivity_type)

### Текущее состояние:
```
0b01100000 (decimal: 96) -> 13 компонентов  
0b01000000 (decimal: 64) -> 12 компонентов  
0b00100000 (decimal: 32) ->  5 компонентов  
```

### Интерпретация битов:
- **Бит 5 (32)**: Ми-8Т/Ми-8П/Ми-8ПС  
- **Бит 6 (64)**: Ми-17/Ми-8АМТ/Ми-8МТВ  
- **Бит 7 (96 = 64+32)**: Универсальные компоненты (оба типа)

### Стратегия сжатия:
**String → UInt16**
```sql
0b01100000 → 1  -- Универсальные
0b01000000 → 2  -- Только Ми-17 
0b00100000 → 3  -- Только Ми-8Т
```
**Экономия памяти**: ~93.9% (33 символа → 2 байта)

## 2. Группировка оборота (group_by)

### Логика группировки:
```
0 → Совместный оборот (18 компонентов)    -- НЕ группируются с другими агрегатами
1 → Индивидуальный оборот (2 компонента)  -- АП 1960, АП 1950 (индивидуально)
2 → Группа ЛНВ (2 компонента)             -- Группируются между собой
3 → Группа ХР (2 компонента)              -- Группируются между собой  
4 → Группа ПР (2 компонента)              -- Группируются между собой
5 → Группа ХВ (2 компонента)              -- Группируются между собой
6 → Группа КВПВ (2 компонента)            -- Группируются между собой
```

### Стратегия:
Уже оптимально как **UInt8** (0-255). Дополнительное сжатие не требуется.

## 3. Взаимозаменяемые компоненты

### Выявлены 4 группы взаимозаменяемых партномеров:

#### 3.1. РВ (Рулевой винт)
```
8-3904-000 СЕРИЯ 06   → effectivity_type=3 (Ми-8Т)
246-3904-000 СЕРИИ 01 → effectivity_type=2 (Ми-17)
```

#### 3.2. ЛРВ (Лопатки рулевого винта)  
```
8-3922-00   → effectivity_type=3 (Ми-8Т)
246-3925-00 → effectivity_type=2 (Ми-17)
```

#### 3.3. ЛНВ (Лопатки несущего винта)
```
8АТ.2710.000 → effectivity_type=1 (Универсальные)
8АТ.2710.00  → effectivity_type=1 (Универсальные)
```

#### 3.4. КВПВ (Коробки приводов винтов)
```
8А-6314-00   → effectivity_type=1 (Универсальные)  
8АТ.6314.000 → effectivity_type=1 (Универсальные)
```

## 4. Стратегия партномеров (partno)

### Статистика:
- **30 уникальных партномеров**
- **Средняя длина**: 13.0 символов  
- **Максимальная длина**: 33 символа
- **Экономия UInt16**: 93.9%

### Проблема многострочных партномеров:
Некоторые партномера содержат несколько вариантов через `\n`:
```
"МИ-8Т\nМИ-8П\nМИ-8ПС\nМи-8ТП"
"ТВ2-117А\nТВ2-117АГ"  
"8А-6311-00 4 СЕР\n8А-6311-00 3 СЕР"
```

### Рекомендация:
1. **Разделить** многострочные партномера на отдельные записи
2. **Создать mapping-таблицу** partno_id → actual_partno  
3. **Использовать UInt16 кодирование** в основных таблицах

## 5. ClickHouse DDL для сжатия

### 5.1. Таблицы маппинга
```sql
-- Маппинг типов применимости
CREATE TABLE effectivity_type_mapping (
    id UInt16,
    binary_mask String,
    decimal_value UInt16, 
    description String,
    mi8t_compatible UInt8,
    mi17_compatible UInt8
) ENGINE = Memory;

-- Маппинг партномеров  
CREATE TABLE partno_mapping (
    id UInt16,
    partno String,
    component_name String,
    effectivity_type_id UInt16
) ENGINE = Memory;

-- Маппинг групп оборота
CREATE TABLE group_by_mapping (
    id UInt8,
    description String,
    management_type Enum8('individual'=1, 'group'=2)
) ENGINE = Memory;
```

### 5.2. Оптимизированная структура фактовой таблицы
```sql
CREATE TABLE components_optimized (
    component_name String,
partno_id UInt16,          -- вместо String
    qty_per_aircraft UInt8,
    group_by_id UInt8,                         -- вместо UInt16
    effectivity_type_id UInt16, -- вместо String  
    type_restricted UInt8,
    effectivity_shaft UInt8,
    -- остальные поля...
) ENGINE = MergeTree()
ORDER BY (component_name, partno_id);
```

## 6. Бизнес-логика взаимозаменяемости

### Правило определения взаимозаменяемых компонентов:
```sql
-- Компоненты считаются взаимозаменяемыми, если:
SELECT component_name, 
       groupArray(partno_id) as interchangeable_partnos
FROM components_optimized  
GROUP BY component_name
HAVING length(interchangeable_partnos) > 1;
```

### Применение в ABM-модели:
1. **Agent.partno_id** хранит текущий установленный партномер
2. **При поиске замены** ищем все partno_id с тем же component_name
3. **Фильтруем по effectivity_type_id** (совместимость с типом ВС)
4. **Учитываем группировку group_by_id** для управления запасами

## 7. Экономия ресурсов

### Оценка сжатия для таблицы на 1M записей:

| Поле | Было | Стало | Экономия |
|------|------|-------|----------|
| partno | 33 bytes | 2 bytes | 94% |
| effectivity_type | 10 bytes | 2 bytes | 80% |
| component_name | LowCardinality | LowCardinality | 0% |
| **Итого на запись** | **~45 bytes** | **~6 bytes** | **87%** |
| **На 1M записей** | **45 MB** | **6 MB** | **39 MB экономии** |

### Дополнительные преимущества:
1. **Быстрее JOIN-ы** (UInt16 vs String)
2. **Эффективнее индексы** (2 байта vs 33 байта)  
3. **Лучше сжатие** в ClickHouse CODEC
4. **Меньше сетевого трафика** при запросах 