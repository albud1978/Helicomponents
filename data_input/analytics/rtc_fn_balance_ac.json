{
  "rtc_function": "fn_balance_ac",
  "aircraft_type": "ALL",
  "ac_type_mask": "32|64",
  "execution_condition": "trigger_program != 0",
  
  "macroproperty_sources": [
    {"name": "ops_counter_mi8", "type": "MacroProperty4", "field_id": 74},
    {"name": "ops_counter_mi17", "type": "MacroProperty4", "field_id": 75},
    {"name": "trigger_program", "type": "MacroProperty4", "field_id": 80}
  ],
  
  "algorithm": {
    "type": "iterative_balance",
    "goal": "DEFICIT = 0",
    "steps": [
      {
        "step": 1,
        "condition": "DEFICIT > 0",
        "source_status": 2,
        "target_status": 3,
        "description": "Эксплуатация → Исправен (избыток)",
        "transfer_count": "min(count(status_id=2), DEFICIT)",
        "deficit_update": "DEFICIT -= transferred"
      },
      {
        "step": 2,
        "condition": "DEFICIT < 0",
        "source_status": 3,
        "target_status": 2,
        "description": "Исправен → Эксплуатация (недостаток)",
        "transfer_count": "min(count(status_id=3), |DEFICIT|)",
        "deficit_update": "DEFICIT += transferred"
      },
      {
        "step": 3,
        "condition": "DEFICIT < 0",
        "source_status": 5,
        "target_status": 2,
        "description": "Резерв → Эксплуатация (недостаток)",
        "transfer_count": "min(count(status_id=5), |DEFICIT|)",
        "deficit_update": "DEFICIT += transferred"
      },
      {
        "step": 4,
        "condition": "DEFICIT < 0",
        "source_status": 1,
        "target_status": 2,
        "description": "Неактивно → Эксплуатация (недостаток)",
        "transfer_count": "min(count(status_id=1), |DEFICIT|)",
        "deficit_update": "DEFICIT += transferred",
        "macroproperty_update": {
          "name": "active_trigger",
          "type": "MacroProperty2",
          "field_id": 14,
          "formula": "current_date - repair_time"
        }
      }
    ]
  },
  
  "deficit_calculation": {
    "mi8": "count(status_id=2 AND ac_type_mask=32) - ops_counter_mi8",
    "mi17": "count(status_id=2 AND ac_type_mask=64) - ops_counter_mi17"
  },
  
  "variables": {
    "input": [
      {"name": "status_id", "type": "Variable", "source": "agent"},
      {"name": "ac_type_mask", "type": "Variable", "source": "agent"}
    ],
    "output": [
      {"name": "status_id", "type": "Variable", "target": "agent", "action": "conditional_change"}
    ]
  }
}