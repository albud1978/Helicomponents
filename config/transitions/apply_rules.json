{
  "version": 1,
  "matrix": {
    "from": "intent",
    "to": "state"
  },
  "states": {
    "0": "spawn",
    "1": "inactive",
    "2": "operations",
    "3": "serviceable",
    "4": "repair",
    "5": "reserve",
    "6": "storage",
    "7": "unserviceable"
  },
  "intents": {
    "0": "spawn",
    "1": "inactive",
    "2": "operations",
    "3": "serviceable",
    "4": "repair",
    "5": "reserve",
    "6": "storage",
    "7": "unserviceable"
  },
  "variables": [
    "state",
    "intent_state",
    "repair_days",
    "repair_time",
    "assembly_trigger",
    "active_trigger",
    "s4_days",
    "repair_line_id",
    "ppr",
    "group_by",
    "daily_today_u32",
    "daily_next_u32"
  ],
  "rules": [
    {
      "id": "inactive_apply_hold",
      "from": 1,
      "to": 1,
      "pre": {
        "all": [
          {
            "expr": "intent_state == 1"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 1"
          }
        ]
      },
      "owner_module": "rtc_state_manager_inactive",
      "notes": "Подтверждение inactive"
    },
    {
      "id": "inactive_apply_to_operations",
      "from": 2,
      "to": 2,
      "pre": {
        "all": [
          {
            "expr": "state == 1"
          },
          {
            "expr": "intent_state == 2"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 2"
          },
          {
            "expr": "active_trigger == 1"
          }
        ]
      },
      "owner_module": "rtc_state_manager_operations",
      "notes": "Промоут из inactive в operations"
    },
    {
      "id": "operations_apply_hold",
      "from": 2,
      "to": 2,
      "pre": {
        "all": [
          {
            "expr": "state == 2"
          },
          {
            "expr": "intent_state == 2"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 2"
          }
        ]
      },
      "owner_module": "rtc_state_manager_operations",
      "notes": "Остаётся в operations"
    },
    {
      "id": "operations_apply_to_serviceable",
      "from": 3,
      "to": 3,
      "pre": {
        "all": [
          {
            "expr": "state == 2"
          },
          {
            "expr": "intent_state == 3"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 3"
          }
        ]
      },
      "owner_module": "rtc_state_manager_operations",
      "notes": "Квотный демоут operations → serviceable"
    },
    {
      "id": "operations_apply_to_repair",
      "from": 4,
      "to": 4,
      "pre": {
        "all": [
          {
            "expr": "state == 2"
          },
          {
            "expr": "intent_state == 4"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 4"
          }
        ]
      },
      "owner_module": "rtc_state_manager_operations",
      "notes": "Переход в ремонт"
    },
    {
      "id": "operations_apply_to_unserviceable",
      "from": 7,
      "to": 7,
      "pre": {
        "all": [
          {
            "expr": "state == 2"
          },
          {
            "expr": "intent_state == 7"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 7"
          },
          {
            "expr": "intent_state == 0"
          },
          {
            "expr": "s4_days == 1"
          }
        ]
      },
      "owner_module": "rtc_state_manager_operations",
      "notes": "Очередь на ремонт (unserviceable)"
    },
    {
      "id": "operations_apply_to_storage",
      "from": 6,
      "to": 6,
      "pre": {
        "all": [
          {
            "expr": "state == 2"
          },
          {
            "expr": "intent_state == 6"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 6"
          }
        ]
      },
      "owner_module": "rtc_state_manager_operations",
      "notes": "Переход в storage"
    },
    {
      "id": "serviceable_apply_hold",
      "from": 3,
      "to": 3,
      "pre": {
        "all": [
          {
            "expr": "state == 3"
          },
          {
            "expr": "intent_state == 3"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 3"
          }
        ]
      },
      "owner_module": "rtc_state_manager_serviceable",
      "notes": "Holding в serviceable"
    },
    {
      "id": "serviceable_apply_to_operations",
      "from": 2,
      "to": 2,
      "pre": {
        "all": [
          {
            "expr": "state == 3"
          },
          {
            "expr": "intent_state == 2"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 2"
          }
        ]
      },
      "owner_module": "rtc_state_manager_operations",
      "notes": "Промоут P1: serviceable → operations"
    },
    {
      "id": "repair_apply_hold",
      "from": 4,
      "to": 4,
      "pre": {
        "all": [
          {
            "expr": "state == 4"
          },
          {
            "expr": "intent_state == 4"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 4"
          }
        ]
      },
      "owner_module": "rtc_state_manager_repair",
      "notes": "Остаётся в ремонте"
    },
    {
      "id": "repair_apply_to_serviceable",
      "from": 3,
      "to": 3,
      "pre": {
        "all": [
          {
            "expr": "state == 4"
          },
          {
            "expr": "intent_state == 3"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 3"
          },
          {
            "expr": "repair_days == 0"
          },
          {
            "expr": "assembly_trigger == 0"
          }
        ]
      },
      "owner_module": "rtc_state_manager_repair",
      "notes": "Завершение ремонта"
    },
    {
      "id": "reserve_apply_hold",
      "from": 5,
      "to": 5,
      "pre": {
        "all": [
          {
            "expr": "state == 5"
          },
          {
            "expr": "intent_state == 5"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 5"
          }
        ]
      },
      "owner_module": "rtc_state_manager_reserve",
      "notes": "Общий hold в reserve"
    },
    {
      "id": "reserve_apply_queue_hold",
      "from": 5,
      "to": 5,
      "pre": {
        "all": [
          {
            "expr": "state == 5"
          },
          {
            "expr": "intent_state == 0"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 5"
          }
        ]
      },
      "owner_module": "rtc_state_manager_reserve",
      "notes": "Очередь ремонта внутри reserve"
    },
    {
      "id": "reserve_apply_to_repair",
      "from": 4,
      "to": 4,
      "pre": {
        "all": [
          {
            "expr": "state == 5"
          },
          {
            "expr": "intent_state == 4"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 4"
          }
        ]
      },
      "owner_module": "rtc_state_manager_reserve",
      "notes": "Одобрение очереди в ремонт"
    },
    {
      "id": "reserve_apply_to_operations",
      "from": 2,
      "to": 2,
      "pre": {
        "all": [
          {
            "expr": "state == 5"
          },
          {
            "expr": "intent_state == 2"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 2"
          }
        ]
      },
      "owner_module": "rtc_state_manager_operations",
      "notes": "Промоут из reserve → operations"
    },
    {
      "id": "storage_apply_hold",
      "from": 6,
      "to": 6,
      "pre": {
        "all": [
          {
            "expr": "state == 6"
          },
          {
            "expr": "intent_state == 6"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 6"
          }
        ]
      },
      "owner_module": "rtc_state_manager_storage",
      "notes": "Storage immutable"
    },
    {
      "id": "unserviceable_apply_hold",
      "from": 7,
      "to": 7,
      "pre": {
        "all": [
          {
            "expr": "state == 7"
          },
          {
            "expr": "intent_state == 0"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 7"
          }
        ]
      },
      "owner_module": "rtc_state_manager_unserviceable",
      "notes": "Очередь ремонта в unserviceable"
    },
    {
      "id": "unserviceable_apply_to_repair",
      "from": 4,
      "to": 4,
      "pre": {
        "all": [
          {
            "expr": "state == 7"
          },
          {
            "expr": "intent_state == 4"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 4"
          }
        ]
      },
      "owner_module": "rtc_state_manager_unserviceable",
      "notes": "Одобрение очереди в ремонт"
    },
    {
      "id": "unserviceable_apply_to_operations",
      "from": 2,
      "to": 2,
      "pre": {
        "all": [
          {
            "expr": "state == 7"
          },
          {
            "expr": "intent_state == 2"
          }
        ]
      },
      "post": {
        "all": [
          {
            "expr": "state == 2"
          }
        ]
      },
      "owner_module": "rtc_state_manager_unserviceable",
      "notes": "Промоут P2: unserviceable → operations"
    }
  ]
}
