# Правила проекта (консолидировано)

- Всегда отвечать на русском языке.
- Рабочая разработка — в `code/`. Архив `archive_vnv_cpu_project/` не трогать.
- Запрещено создавать фейковые файлы/результаты и использовать хардкод (кроме лок. отладки с тестами и фиксацией).
- Минимальный дифф по умолчанию: ≤3 файлов, ≤150 строк, 1 подсистема, без новых публичных API.
- Любые изменения архитектуры/алгоритмов/схем данных — только после явного согласования в чате.

## Данные и типы
- В СУБД избегать Float64 без согласования. Предпочтать: UInt8/16/32 и Float32.
- MP5 (суточные минуты) — хранить в `UInt16/UInt32` в Env (в соответствии с источником).
- Тесты/прогоны выполнять ТОЛЬКО на реальных данных из ClickHouse. Синтетика/заглушки — только с явным разрешением Алексея в текущем чате.

## Transform / RTC инварианты (v3 - state-based, 22.12.2024)
- Один процесс: единый `ModelDescription` + `CUDASimulation`, без перезагрузки `env` между шагами.
- FRAMES = |MP3 ∪ MP5| (без расширения «впрок»). Индексы для будущих бортов берутся из объединения.
- **Фильтрация планеров**: Из ~7113 строк MP3 агентами становятся только планеры с group_by ∈ {1,2} (~286 бортов).
- MP5 держать в `MacroProperty mp5_lin[MAX_SIZE]` с фиксированным MAX_SIZE; инициализация ТОЛЬКО через HostFunction до первых RTC.
- Запрет записи в `mp5_lin` после начала чтения агентами. RTC копирование запрещено.
- Размеры MacroProperty: MAX_FRAMES определяется из данных MP3/MP5, MAX_DAYS=4000, MAX_SIZE=MAX_FRAMES*(MAX_DAYS+1).
- **OH при создании**: Значения oh (overhaul hours) определять при создании агентов из MP1 по group_by, НЕ в RTC. OH в MP1 уже хранится в минутах, умножать на 60 НЕ НАДО!
  - Использовать `mp1_index` для получения индекса: `pidx = mp1_index.get(partseqno, -1)`
  - Для Mi-8 (group_by=1): брать из `mp1_oh_mi8[pidx]`
  - Для Mi-17 (group_by=2): брать из `mp1_oh_mi17[pidx]`
- **Assembly trigger при создании**: Для агентов в статусе 4 проверять `repair_time - repair_days > assembly_time` и устанавливать `assembly_trigger = 1` если условие выполнено.
- **State-based архитектура**: Использовать FLAME GPU States вместо переменной status_id.
- **Отдельные RTC функции**: Каждое состояние имеет свою RTC функцию для модульности.
- **Разделение логики**: RTC функции состояний НЕ меняют state, только устанавливают intent флаги.
- **Централизованное квотирование**: Единый менеджер квот с приоритетами без атомарных операций.
- **Атомарные переходы**: Все смены состояний в единой RTC функции `rtc_state_transitions`.

## Тестирование и валидации (обновлено 13.10.2025)

### Приоритет валидации
- **Основной контроль**: Итоговая выгрузка в СУБД через MP2 (device-side export).
- **Логирование в RTC коде**: Добавляется ТОЛЬКО по явному согласованию Алексея в текущем чате.
- **Удаление логов**: После успешного устранения проблемы код логирования УДАЛЯЕТСЯ + повторное тестирование.
- **Критерий успеха**: Тест считается успешным только при подтверждении результатов в СУБД БЕЗ избыточного логирования.

### Риски логирования в CUDA ядрах
При добавлении `printf` или других операций логирования в RTC ядра учитывать:
- Race conditions (конкурентная запись в stdout от тысяч потоков)
- Потенциальные сбои компиляции NVRTC
- Ограничения FLAME GPU на вывод из device-side кода
- Производительность (логирование может замедлить симуляцию в десятки раз)

### Матрица тестов
- DAYS={5,90,365,3650}. Детерминизм повторных прогонов на одном снапшоте.
- Для валидации модулей: полный прогон на 3650 дней (все ядра скомпилированы).

### Инварианты
- S6 неизменяем, Δsne_s2 == sum(dt_s2), корректный D+1 паддинг MP5.
- Все проверки инвариантов выполняются SQL-запросами к СУБД.

## Документация и процесс
- Перед правками — анализ влияния на ETL/скрипты; после — обновление MD только при зелёных тестах.
- **Обязательное ведение**: `docs/validation.md` по всем модулям с результатами проверок.
- **Связи в документации**: README.md ↔ validation.md ↔ .cursorrules (этот файл).
- Обновлять `docs/rtc_pipeline_architecture.md` при изменении оркестрации/ядер.
- Обновлять `docs/validation.md` при изменении проверок или добавлении новых модулей.
- Хранить этот файл правил как источник истины.



