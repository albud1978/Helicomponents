<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transitions Viewer</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 24px; }
    h1, h2 { margin: 0 0 8px; }
    .meta { color: #666; font-size: 12px; margin-bottom: 16px; }
    .section { margin-bottom: 20px; }
    .states { display: flex; flex-wrap: wrap; gap: 8px; }
    .state-badge { background: #2a5bd7; color: white; padding: 3px 8px; border-radius: 10px; font-size: 12px; }
    table.matrix { width: 100%; border-collapse: collapse; table-layout: fixed; }
    table.matrix th, table.matrix td { border: 1px solid #ccc; padding: 6px; vertical-align: top; }
    table.matrix th { background: #f3f3f3; }
    .from-header { text-align: left; }
    .empty { color: #888; text-align: center; }
    details.rule-card { margin: 6px 0; border: 1px solid #ddd; border-radius: 6px; padding: 6px; background: #fafafa; }
    summary { cursor: pointer; list-style: none; }
    summary::-webkit-details-marker { display: none; }
    .badge { display: inline-block; padding: 2px 6px; border-radius: 10px; background: #2a5bd7; color: white; font-size: 11px; margin-right: 6px; }
    .rule-id { font-weight: 600; margin-right: 8px; }
    .rule-owner { color: #666; font-size: 11px; }
    .rule-body { margin-top: 8px; }
    .rule-section { margin-bottom: 6px; }
    .label { font-size: 11px; color: #444; text-transform: uppercase; }
    .value { font-size: 12px; white-space: pre-wrap; }
    .value.pre, .value.post { font-family: monospace; }
    .notes { font-size: 11px; color: #666; }
    .arrow { color: #2a5bd7; }
  </style>
</head>
<body>
  <h1>Transitions Viewer</h1>
  <div class="meta">Generated from config/transitions/intent_rules.json and apply_rules.json at 2026-01-29 18:01:59 UTC</div>
  <div class="meta">Run: python3 tools/transitions_viewer/build_transitions_viewer.py</div>
  <div id="app"></div>
  <script>
    const TRANSITIONS_DATA = {"intent": {"version": 1, "matrix": {"from": "state", "to": "intent"}, "states": {"0": "spawn", "1": "inactive", "2": "operations", "3": "serviceable", "4": "repair", "5": "reserve", "6": "storage", "7": "unserviceable"}, "intents": {"0": "spawn", "1": "inactive", "2": "operations", "3": "serviceable", "4": "repair", "5": "reserve", "6": "storage", "7": "unserviceable"}, "variables": ["state", "intent_state", "sne", "ppr", "dt", "dn", "ll", "oh", "br", "repair_days", "repair_time", "group_by", "daily_today_u32", "daily_next_u32", "s4_days", "active_trigger", "assembly_trigger"], "derived": [{"name": "s_next", "expr": "sne + dt + dn"}, {"name": "p_next", "expr": "ppr + dt + dn"}], "rules": [{"id": "spawn_intent_operations", "from": 0, "to": 2, "pre": {"all": [{"expr": "true"}]}, "post": {"all": [{"expr": "intent_state == 2"}]}, "owner_module": "rtc_spawn_dynamic", "notes": "Динамический спавн с интентом operations"}, {"id": "spawn_intent_serviceable", "from": 0, "to": 3, "pre": {"all": [{"expr": "true"}]}, "post": {"all": [{"expr": "intent_state == 3"}]}, "owner_module": "rtc_spawn_v2", "notes": "Детерминированный спавн с интентом serviceable"}, {"id": "inactive_intent_hold", "from": 1, "to": 1, "pre": {"all": [{"expr": "true"}]}, "post": {"all": [{"expr": "intent_state == 1"}]}, "owner_module": "rtc_states_stub", "notes": "Удержание в inactive"}, {"id": "operations_intent_storage_ll", "from": 2, "to": 6, "pre": {"all": [{"expr": "s_next >= ll"}]}, "post": {"all": [{"expr": "intent_state == 6"}]}, "owner_module": "rtc_state_2_operations", "notes": "Списание по LL"}, {"id": "operations_intent_unserviceable_oh", "from": 2, "to": 7, "pre": {"all": [{"expr": "p_next >= oh"}, {"expr": "s_next < br"}]}, "post": {"all": [{"expr": "intent_state == 7"}]}, "owner_module": "rtc_state_2_operations", "notes": "Очередь на ремонт (unserviceable)"}, {"id": "operations_intent_storage_oh_br", "from": 2, "to": 6, "pre": {"all": [{"expr": "p_next >= oh"}, {"expr": "s_next >= br"}]}, "post": {"all": [{"expr": "intent_state == 6"}]}, "owner_module": "rtc_state_2_operations", "notes": "Списание по OH+BR"}, {"id": "operations_intent_hold", "from": 2, "to": 2, "pre": {"all": [{"expr": "s_next < ll"}, {"expr": "p_next < oh"}]}, "post": {"all": [{"expr": "intent_state == 2"}]}, "owner_module": "rtc_state_2_operations", "notes": "Остаётся в operations"}, {"id": "serviceable_intent_hold", "from": 3, "to": 3, "pre": {"all": [{"expr": "true"}]}, "post": {"all": [{"expr": "intent_state == 3"}]}, "owner_module": "rtc_states_stub", "notes": "Holding в serviceable"}, {"id": "repair_intent_serviceable", "from": 4, "to": 3, "pre": {"all": [{"expr": "repair_days >= repair_time"}]}, "post": {"all": [{"expr": "intent_state == 3"}]}, "owner_module": "rtc_states_stub", "notes": "Готовность к выходу из ремонта"}, {"id": "repair_intent_hold", "from": 4, "to": 4, "pre": {"all": [{"expr": "repair_days < repair_time"}]}, "post": {"all": [{"expr": "intent_state == 4"}]}, "owner_module": "rtc_states_stub", "notes": "Остаётся в ремонте"}, {"id": "reserve_intent_hold", "from": 5, "to": 5, "pre": {"all": [{"expr": "true"}]}, "post": {"all": [{"expr": "intent_state == 5"}]}, "owner_module": "rtc_states_stub", "notes": "Остаётся в reserve"}, {"id": "storage_intent_hold", "from": 6, "to": 6, "pre": {"all": [{"expr": "true"}]}, "post": {"all": [{"expr": "intent_state == 6"}]}, "owner_module": "rtc_states_stub", "notes": "Storage immutable"}, {"id": "unserviceable_intent_queue", "from": 7, "to": 0, "pre": {"all": [{"expr": "true"}]}, "post": {"all": [{"expr": "intent_state == 0"}]}, "owner_module": "rtc_states_stub", "notes": "Очередь на ремонт"}]}, "apply": {"version": 1, "matrix": {"from": "intent", "to": "state"}, "states": {"0": "spawn", "1": "inactive", "2": "operations", "3": "serviceable", "4": "repair", "5": "reserve", "6": "storage", "7": "unserviceable"}, "intents": {"0": "spawn", "1": "inactive", "2": "operations", "3": "serviceable", "4": "repair", "5": "reserve", "6": "storage", "7": "unserviceable"}, "variables": ["state", "intent_state", "repair_days", "repair_time", "assembly_trigger", "active_trigger", "s4_days", "repair_line_id", "ppr", "group_by", "daily_today_u32", "daily_next_u32"], "rules": [{"id": "inactive_apply_hold", "from": 1, "to": 1, "pre": {"all": [{"expr": "intent_state == 1"}]}, "post": {"all": [{"expr": "state == 1"}]}, "owner_module": "rtc_state_manager_inactive", "notes": "Подтверждение inactive"}, {"id": "inactive_apply_to_operations", "from": 2, "to": 2, "pre": {"all": [{"expr": "state == 1"}, {"expr": "intent_state == 2"}]}, "post": {"all": [{"expr": "state == 2"}, {"expr": "active_trigger == 1"}]}, "owner_module": "rtc_state_manager_operations", "notes": "Промоут из inactive в operations"}, {"id": "operations_apply_hold", "from": 2, "to": 2, "pre": {"all": [{"expr": "state == 2"}, {"expr": "intent_state == 2"}]}, "post": {"all": [{"expr": "state == 2"}]}, "owner_module": "rtc_state_manager_operations", "notes": "Остаётся в operations"}, {"id": "operations_apply_to_serviceable", "from": 3, "to": 3, "pre": {"all": [{"expr": "state == 2"}, {"expr": "intent_state == 3"}]}, "post": {"all": [{"expr": "state == 3"}]}, "owner_module": "rtc_state_manager_operations", "notes": "Квотный демоут operations → serviceable"}, {"id": "operations_apply_to_repair", "from": 4, "to": 4, "pre": {"all": [{"expr": "state == 2"}, {"expr": "intent_state == 4"}]}, "post": {"all": [{"expr": "state == 4"}]}, "owner_module": "rtc_state_manager_operations", "notes": "Переход в ремонт"}, {"id": "operations_apply_to_unserviceable", "from": 7, "to": 7, "pre": {"all": [{"expr": "state == 2"}, {"expr": "intent_state == 7"}]}, "post": {"all": [{"expr": "state == 7"}, {"expr": "intent_state == 0"}, {"expr": "s4_days == 1"}]}, "owner_module": "rtc_state_manager_operations", "notes": "Очередь на ремонт (unserviceable)"}, {"id": "operations_apply_to_storage", "from": 6, "to": 6, "pre": {"all": [{"expr": "state == 2"}, {"expr": "intent_state == 6"}]}, "post": {"all": [{"expr": "state == 6"}]}, "owner_module": "rtc_state_manager_operations", "notes": "Переход в storage"}, {"id": "serviceable_apply_hold", "from": 3, "to": 3, "pre": {"all": [{"expr": "state == 3"}, {"expr": "intent_state == 3"}]}, "post": {"all": [{"expr": "state == 3"}]}, "owner_module": "rtc_state_manager_serviceable", "notes": "Holding в serviceable"}, {"id": "serviceable_apply_to_operations", "from": 2, "to": 2, "pre": {"all": [{"expr": "state == 3"}, {"expr": "intent_state == 2"}]}, "post": {"all": [{"expr": "state == 2"}]}, "owner_module": "rtc_state_manager_operations", "notes": "Промоут P1: serviceable → operations"}, {"id": "repair_apply_hold", "from": 4, "to": 4, "pre": {"all": [{"expr": "state == 4"}, {"expr": "intent_state == 4"}]}, "post": {"all": [{"expr": "state == 4"}]}, "owner_module": "rtc_state_manager_repair", "notes": "Остаётся в ремонте"}, {"id": "repair_apply_to_serviceable", "from": 3, "to": 3, "pre": {"all": [{"expr": "state == 4"}, {"expr": "intent_state == 3"}]}, "post": {"all": [{"expr": "state == 3"}, {"expr": "repair_days == 0"}, {"expr": "assembly_trigger == 0"}]}, "owner_module": "rtc_state_manager_repair", "notes": "Завершение ремонта"}, {"id": "reserve_apply_hold", "from": 5, "to": 5, "pre": {"all": [{"expr": "state == 5"}, {"expr": "intent_state == 5"}]}, "post": {"all": [{"expr": "state == 5"}]}, "owner_module": "rtc_state_manager_reserve", "notes": "Общий hold в reserve"}, {"id": "reserve_apply_queue_hold", "from": 5, "to": 5, "pre": {"all": [{"expr": "state == 5"}, {"expr": "intent_state == 0"}]}, "post": {"all": [{"expr": "state == 5"}]}, "owner_module": "rtc_state_manager_reserve", "notes": "Очередь ремонта внутри reserve"}, {"id": "reserve_apply_to_repair", "from": 4, "to": 4, "pre": {"all": [{"expr": "state == 5"}, {"expr": "intent_state == 4"}]}, "post": {"all": [{"expr": "state == 4"}]}, "owner_module": "rtc_state_manager_reserve", "notes": "Одобрение очереди в ремонт"}, {"id": "reserve_apply_to_operations", "from": 2, "to": 2, "pre": {"all": [{"expr": "state == 5"}, {"expr": "intent_state == 2"}]}, "post": {"all": [{"expr": "state == 2"}]}, "owner_module": "rtc_state_manager_operations", "notes": "Промоут из reserve → operations"}, {"id": "storage_apply_hold", "from": 6, "to": 6, "pre": {"all": [{"expr": "state == 6"}, {"expr": "intent_state == 6"}]}, "post": {"all": [{"expr": "state == 6"}]}, "owner_module": "rtc_state_manager_storage", "notes": "Storage immutable"}, {"id": "unserviceable_apply_hold", "from": 7, "to": 7, "pre": {"all": [{"expr": "state == 7"}, {"expr": "intent_state == 0"}]}, "post": {"all": [{"expr": "state == 7"}]}, "owner_module": "rtc_state_manager_unserviceable", "notes": "Очередь ремонта в unserviceable"}, {"id": "unserviceable_apply_to_repair", "from": 4, "to": 4, "pre": {"all": [{"expr": "state == 7"}, {"expr": "intent_state == 4"}]}, "post": {"all": [{"expr": "state == 4"}]}, "owner_module": "rtc_state_manager_unserviceable", "notes": "Одобрение очереди в ремонт"}, {"id": "unserviceable_apply_to_operations", "from": 2, "to": 2, "pre": {"all": [{"expr": "state == 7"}, {"expr": "intent_state == 2"}]}, "post": {"all": [{"expr": "state == 2"}]}, "owner_module": "rtc_state_manager_unserviceable", "notes": "Промоут P2: unserviceable → operations"}]}};
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text ?? '';
      return div.innerHTML;
    }
    function formatCondition(cond) {
      if (!cond) return '';
      if (cond.all) return cond.all.map(c => escapeHtml(c.expr)).join('\nAND\n');
      if (cond.any) return cond.any.map(c => escapeHtml(c.expr)).join('\nOR\n');
      if (cond.expr) return escapeHtml(cond.expr);
      return '';
    }
    function renderRuleCard(rule, targetLabel) {
      let html = '<details class="rule-card">';
      const owner = rule.owner_module ? escapeHtml(rule.owner_module) : '';
      html += owner
        ? `<summary><span class=\"badge\">rule</span><span class=\"rule-owner\">${owner}</span></summary>`
        : `<summary><span class=\"badge\">rule</span><span class=\"rule-id\">${escapeHtml(rule.id)}</span></summary>`;
      html += '<div class="rule-body">';
      if (rule.pre) html += `<div class="rule-section"><div class="label">pre</div><div class="value pre">${formatCondition(rule.pre)}</div></div>`;
      if (rule.post) html += `<div class="rule-section"><div class="label">post</div><div class="value post">${formatCondition(rule.post)}</div></div>`;
      if (rule.effects) html += `<div class=\"rule-section\"><div class=\"label\">effects</div><div class=\"value\">${escapeHtml(JSON.stringify(rule.effects))}</div></div>`;
      if (rule.notes) html += `<div class="notes">${escapeHtml(rule.notes)}</div>`;
      html += '</div></details>';
      return html;
    }
    function getIds(mapObj, rules, key) {
      const ids = Object.keys(mapObj || {}).map(Number).filter(n => !Number.isNaN(n));
      if (ids.length) return ids.sort((a, b) => a - b);
      const vals = (rules || []).map(r => r[key]);
      return Array.from(new Set(vals)).filter(n => n !== undefined).sort((a, b) => a - b);
    }
    function renderLegend(title, mapObj) {
      const ids = Object.keys(mapObj || {}).map(Number).filter(n => !Number.isNaN(n)).sort((a, b) => a - b);
      if (!ids.length) return '';
      let html = `<div class=\"section\"><h2>${escapeHtml(title)}</h2><div class=\"states\">`;
      ids.forEach(id => {
        const name = mapObj?.[String(id)] || `${title.toLowerCase()}_${id}`;
        html += `<div class=\"state-badge\">${id}: ${escapeHtml(name)}</div>`;
      });
      html += '</div></div>';
      return html;
    }
    function renderMatrixBlock(data, title) {
      const app = document.getElementById('app');
      const matrix = data.matrix || { from: 'state', to: 'state' };
      const fromMap = matrix.from === 'intent' ? (data.intents || {}) : (data.states || {});
      const toMap = matrix.to === 'intent' ? (data.intents || {}) : (data.states || {});
      const fromIds = getIds(fromMap, data.rules, 'from');
      const toIds = getIds(toMap, data.rules, 'to');
      let html = '';
      html += `<div class=\"section\"><h2>${escapeHtml(title)}</h2></div>`;
      html += renderLegend('States', data.states);
      if (data.intents) html += renderLegend('Intents', data.intents);
      if (data.derived?.length) {
        html += '<div class=\"section\"><h2>Derived</h2>';
        data.derived.forEach(item => {
          html += `<div>${escapeHtml(item.name)} = ${escapeHtml(item.expr)}</div>`;
        });
        html += '</div>';
      }
      html += `<div class=\"section\"><h2>Matrix (${escapeHtml(matrix.from)} → ${escapeHtml(matrix.to)})</h2><table class=\"matrix\">`;
      html += `<thead><tr><th>${escapeHtml(matrix.from)} \\ ${escapeHtml(matrix.to)}</th>`;
      toIds.forEach(id => {
        const name = toMap?.[String(id)] || `${matrix.to}_${id}`;
        html += `<th>${id}<br><small>${escapeHtml(name)}</small></th>`;
      });
      html += '</tr></thead><tbody>';
      fromIds.forEach(fromId => {
        const fromName = fromMap?.[String(fromId)] || `${matrix.from}_${fromId}`;
        html += `<tr><th class=\"from-header\">${fromId}<br><small>${escapeHtml(fromName)}</small></th>`;
        toIds.forEach(toId => {
          const cellRules = (data.rules || []).filter(r => r.from === fromId && r.to === toId);
          html += '<td>';
          if (!cellRules.length) {
            html += '<div class=\"empty\">—</div>';
          } else {
            cellRules.forEach(rule => {
              html += renderRuleCard(rule);
            });
          }
          html += '</td>';
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      if ((data.rules || []).length === 0) {
        html = '<div class=\"section\"><div class=\"notes\">Rules list is empty.</div></div>' + html;
      }
      app.innerHTML += html;
    }
    function renderViewer(data) {
      const app = document.getElementById('app');
      app.innerHTML = '';
      renderMatrixBlock(data.intent, 'Intent Rules (state → intent)');
      renderMatrixBlock(data.apply, 'Apply Rules (intent → state)');
    }
    renderViewer(TRANSITIONS_DATA);
  </script>
</body>
</html>