# FLAME GPU: –ü–æ–ª–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

**–î–∞—Ç–∞:** 02-10-2025  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π  
**–°—Ç–∞—Ç—É—Å:** –í–µ—Ä—Å–∏—è 1.0 ‚Äî –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

---

## üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏

1. **–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞:**
   - `docs/flame_gpu_state_restrictions.md`
   - `docs/flame_gpu_state_solution.md`
   - –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ `code/sim_v2/`

2. **–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏:**
   - FLAME GPU 2 Documentation: https://docs.flamegpu.com/
   - GitHub: https://github.com/FLAMEGPU/FLAMEGPU2
   - Research paper: "FLAME GPU 2: A framework for flexible and performant agent based simulation on GPUs"

3. **Community –ø—Ä–∞–∫—Ç–∏–∫–∏:**
   - GitHub Issues –∏ Discussions
   - –ü—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (circles_bruteforce, predator_prey, etc.)

---

## üö® –ö–†–ò–¢–ò–ß–ù–´–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø

### 1. –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π –≤ –æ–¥–Ω–æ–º Layer

#### 1.1 –ü—Ä–∞–≤–∏–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (–∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ FLAME GPU)

```cpp
// –ò—Å—Ç–æ—á–Ω–∏–∫: FLAMEGPU2/src/flamegpu/model/LayerDescription.cpp
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —Å–ª–æ–π:

if (b->initial_state == f->second->initial_state ||  // ‚ùå –û–±—â–∏–π –í–•–û–î
    b->initial_state == f->second->end_state ||      // ‚ùå –ü–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–µ A‚ÜíB
    b->end_state == f->second->initial_state ||      // ‚ùå –ü–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–µ B‚ÜíA
    b->end_state == f->second->end_state) {          // ‚ùå –û–±—â–∏–π –í–´–•–û–î
    
    THROW exception::InvalidAgentFunc(
        "Agent function '%s' cannot be added to layer, "
        "agent function '%s' within the same layer operates on the same agent state.",
        b->name.c_str(), 
        f->second->name.c_str()
    );
}
```

#### 1.2 –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —Å–ª—É—á–∞—è

##### ‚ùå **–ö–æ–Ω—Ñ–ª–∏–∫—Ç 1: –û–±—â–∏–π initial_state (–≤—Ö–æ–¥)**

```
–§—É–Ω–∫—Ü–∏—è A: state_2 -> state_4
–§—É–Ω–∫—Ü–∏—è B: state_2 -> state_6
            ‚Üë
         –ö–û–ù–§–õ–ò–ö–¢: –æ–±–µ —á–∏—Ç–∞—é—Ç –∏–∑ state_2

–ü—Ä–∏—á–∏–Ω–∞ –∑–∞–ø—Ä–µ—Ç–∞:
- –û–±–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—ã—Ç–∞—é—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ –∞–≥–µ–Ω—Ç–æ–≤
- GPU –Ω–µ –º–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏–º–µ–Ω–∏—Ç—å
- Race condition –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–≤
```

**–ü—Ä–∏–º–µ—Ä –∏–∑ –Ω–∞—à–µ–≥–æ –∫–æ–¥–∞:**
```python
# ‚ùå –ù–ï –ú–û–ì–£–¢ –±—ã—Ç—å –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ:
rtc_2_to_4: operations ‚Üí repair    ‚îê
rtc_2_to_6: operations ‚Üí storage   ‚îú‚îÄ initial_state = "operations"
rtc_2_to_2: operations ‚Üí operations‚îò
```

---

##### ‚ùå **–ö–æ–Ω—Ñ–ª–∏–∫—Ç 2: –û–±—â–∏–π end_state (–≤—ã—Ö–æ–¥)**

```
–§—É–Ω–∫—Ü–∏—è A: state_1 -> state_2
–§—É–Ω–∫—Ü–∏—è B: state_3 -> state_2
                      ‚Üë
                   –ö–û–ù–§–õ–ò–ö–¢: –æ–±–µ –ø–∏—à—É—Ç –≤ state_2

–ü—Ä–∏—á–∏–Ω–∞ –∑–∞–ø—Ä–µ—Ç–∞:
- Race condition –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –∞–≥–µ–Ω—Ç–æ–≤ –≤ —Ü–µ–ª–µ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
- –ü–æ—Ç–µ—Ä—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
```

**–ü—Ä–∏–º–µ—Ä –∏–∑ –Ω–∞—à–µ–≥–æ –∫–æ–¥–∞:**
```python
# ‚ùå –ù–ï –ú–û–ì–£–¢ –±—ã—Ç—å –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ:
rtc_1_to_2: inactive ‚Üí operations    ‚îê
rtc_3_to_2: serviceable ‚Üí operations ‚îú‚îÄ end_state = "operations"
rtc_5_to_2: reserve ‚Üí operations     ‚îò
```

---

##### ‚ùå **–ö–æ–Ω—Ñ–ª–∏–∫—Ç 3: –ü–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–µ A‚ÜíB (–≤—ã—Ö–æ–¥ A = –≤—Ö–æ–¥ B)**

```
–§—É–Ω–∫—Ü–∏—è A: state_1 -> state_2
–§—É–Ω–∫—Ü–∏—è B: state_2 -> state_3
            ‚Üì         ‚Üë
         –ö–û–ù–§–õ–ò–ö–¢: –≤—ã—Ö–æ–¥ A = –≤—Ö–æ–¥ B

–ü—Ä–∏—á–∏–Ω–∞ –∑–∞–ø—Ä–µ—Ç–∞:
- –§—É–Ω–∫—Ü–∏—è B –º–æ–∂–µ—Ç –ø–æ–ø—ã—Ç–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∞–≥–µ–Ω—Ç–æ–≤, —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–µ–π A
- –ù–∞—Ä—É—à–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–∞–≥–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è 0, 1 –∏–ª–∏ 2 —Ä–∞–∑–∞?)
```

**–ü—Ä–∏–º–µ—Ä:**
```python
# ‚ùå –ù–ï –ú–û–ì–£–¢ –±—ã—Ç—å –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ:
rtc_transition_to_ops: serviceable ‚Üí operations  # –°–æ–∑–¥–∞—ë—Ç –∞–≥–µ–Ω—Ç–æ–≤ –≤ operations
rtc_ops_processing: operations ‚Üí operations      # –ú–æ–∂–µ—Ç –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ä–∞–∑—É!
```

---

##### ‚ùå **–ö–æ–Ω—Ñ–ª–∏–∫—Ç 4: –ü–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–µ B‚ÜíA (–≤—Ö–æ–¥ A = –≤—ã—Ö–æ–¥ B)**

```
–§—É–Ω–∫—Ü–∏—è A: state_2 -> state_3
–§—É–Ω–∫—Ü–∏—è B: state_1 -> state_2
                      ‚Üë         ‚Üì
                   –ö–û–ù–§–õ–ò–ö–¢: –≤—Ö–æ–¥ A = –≤—ã—Ö–æ–¥ B

–ü—Ä–∏—á–∏–Ω–∞ –∑–∞–ø—Ä–µ—Ç–∞:
- –°–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–π —Å–ª—É—á–∞–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ 3
- –§—É–Ω–∫—Ü–∏—è A –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∞–≥–µ–Ω—Ç–æ–≤, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–µ–π B
- –ù–∞—Ä—É—à–µ–Ω–∏–µ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º–∞
```

---

##### ‚úÖ **–î–æ–ø—É—Å—Ç–∏–º–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è: –ù–µ–ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏—è**

```
–§—É–Ω–∫—Ü–∏—è A: state_1 -> state_2
–§—É–Ω–∫—Ü–∏—è B: state_3 -> state_4
            ‚úì         ‚úì         ‚úì         ‚úì
         –ù–ï–¢ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π: —Ä–∞–∑–Ω—ã–µ –≤—Ö–æ–¥—ã –∏ –≤—ã—Ö–æ–¥—ã

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:
- –§—É–Ω–∫—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∏—Å—Ç–∏–Ω–Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –Ω–∞ GPU
- –ù–µ—Ç race conditions
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
```

**–ü—Ä–∏–º–µ—Ä –∏–∑ –Ω–∞—à–µ–≥–æ –∫–æ–¥–∞:**
```python
# ‚úÖ –ú–û–ì–£–¢ –±—ã—Ç—å –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ:
rtc_state_1_inactive:    inactive ‚Üí inactive       ‚îê
rtc_state_2_operations:  operations ‚Üí operations   ‚îÇ
rtc_state_3_serviceable: serviceable ‚Üí serviceable ‚îÇ –ù–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π
rtc_state_4_repair:      repair ‚Üí repair           ‚îÇ
rtc_state_5_reserve:     reserve ‚Üí reserve         ‚îÇ
rtc_state_6_storage:     storage ‚Üí storage         ‚îò
```

---

### 2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É —Å–ª–æ—è–º–∏

#### 2.1 –ë–∞—Ä—å–µ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

```
–°–ª–æ–π N:   [–§—É–Ω–∫—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –Ω–∞ GPU]
          ‚Üì
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GPU BARRIER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          ‚Üì –í—Å–µ –ø–æ—Ç–æ–∫–∏ –∂–¥—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
–°–ª–æ–π N+1: [–°–ª–µ–¥—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–∏–¥—è—Ç –í–°–ï –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ —Å–ª–æ—è N]
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ—è ‚Äî **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö GPU –ø–æ—Ç–æ–∫–æ–≤**
- –ë–∞—Ä—å–µ—Ä –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–ª–µ–¥—É—é—â–µ–º—É —Å–ª–æ—é
- Overhead: ~0.1-1–º—Å –Ω–∞ –±–∞—Ä—å–µ—Ä (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–ø—É–ª—è—Ü–∏–∏)

**–ü—Ä–∏–º–µ—Ä:**
```python
layer1 = model.newLayer()
layer1.addAgentFunction(rtc_mark_candidates)  # –ü–∏—à–µ—Ç –≤ –º–∞—Å–∫–∏

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ë–ê–†–¨–ï–† ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

layer2 = model.newLayer()
layer2.addAgentFunction(rtc_process_masks)    # –ß–∏—Ç–∞–µ—Ç –º–∞—Å–∫–∏ ‚Äî –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤–∏–¥–∏—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏
```

---

### 3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ MacroProperty

#### 3.1 –ß—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ

```cpp
// –í –û–î–ù–û–ú —Å–ª–æ–µ –∞–≥–µ–Ω—Ç—ã –º–æ–≥—É—Ç:
‚úÖ –ß–∏—Ç–∞—Ç—å –∏–∑ MacroProperty (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –±–µ–∑–æ–ø–∞—Å–Ω–æ)
‚úÖ –ü–∏—Å–∞—Ç—å –≤ MacroProperty (—Å –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏)

// –ù–û:
‚ö†Ô∏è  –ß—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å –≤ –æ–¥–Ω—É –∏ —Ç—É –∂–µ —è—á–µ–π–∫—É ‚Üí race condition
‚ö†Ô∏è  –ù–µ—Å–∫–æ–ª—å–∫–æ –∞–≥–µ–Ω—Ç–æ–≤ –ø–∏—à—É—Ç –≤ –æ–¥–Ω—É —è—á–µ–π–∫—É ‚Üí –Ω—É–∂–Ω—ã –∞—Ç–æ–º–∏–∫–∏

// –ü—Ä–∏–º–µ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–∞–ø–∏—Å–∏:
auto mask = FLAMEGPU->environment.getMacroProperty<unsigned int, MAX_FRAMES>("mask");
mask[idx].exchange(1u);  // ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è

// –ü—Ä–∏–º–µ—Ä –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–∞–ø–∏—Å–∏:
mask[idx] = 1u;  // ‚ùå Race condition –µ—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–≥–µ–Ω—Ç–æ–≤ –ø–∏—à—É—Ç –≤ idx
```

#### 3.2 –ü–∞—Ç—Ç–µ—Ä–Ω "Write ‚Üí Read ‚Üí Clear"

```python
# –ü–†–ê–í–ò–õ–¨–ù–û: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–ª–æ—è–º
–°–ª–æ–π 1: –û—á–∏—Å—Ç–∫–∞    ‚Üí mask[idx].exchange(0u)  (–∑–∞–ø–∏—Å—å)
–°–ª–æ–π 2: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Üí mask[idx].exchange(1u)  (–∑–∞–ø–∏—Å—å)
–°–ª–æ–π 3: –ß—Ç–µ–Ω–∏–µ     ‚Üí value = mask[idx]       (—á—Ç–µ–Ω–∏–µ)

# –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –í –æ–¥–Ω–æ–º —Å–ª–æ–µ
–°–ª–æ–π 1: 
  - –û—á–∏—Å—Ç–∫–∞    ‚Üí mask[idx] = 0
  - –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Üí mask[idx] = 1  ‚ùå Race condition!
  - –ß—Ç–µ–Ω–∏–µ     ‚Üí value = mask[idx]
```

**–ü—Ä–∏–º–µ—Ä –∏–∑ –Ω–∞—à–µ–≥–æ –∫–æ–¥–∞ (quota_ops_excess):**
```python
layer_clear = model.newLayer()
layer_clear.addAgentFunction(rtc_quota_clear_masks)    # –ó–∞–ø–∏—Å—å: mask[idx] = 0

layer_mark = model.newLayer()
layer_mark.addAgentFunction(rtc_quota_mark_candidates) # –ó–∞–ø–∏—Å—å: mask[idx] = 1

layer_decide = model.newLayer()
layer_decide.addAgentFunction(rtc_quota_manager)       # –ß—Ç–µ–Ω–∏–µ: value = mask[idx]
```

---

### 4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ Messages (–æ–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏)

#### 4.1 –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞

```
–°–ª–æ–π N:   –ê–≥–µ–Ω—Ç—ã –û–¢–ü–†–ê–í–õ–Ø–Æ–¢ —Å–æ–æ–±—â–µ–Ω–∏—è
          ‚Üì
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ë–ê–†–¨–ï–† ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          ‚Üì
–°–ª–æ–π N+1: –ê–≥–µ–Ω—Ç—ã –ß–ò–¢–ê–Æ–¢ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Å–ª–æ—è N

‚ùå –ù–ï–õ–¨–ó–Ø: –ß–∏—Ç–∞—Ç—å –∏ –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –û–î–ù–û–ú —Å–ª–æ–µ
‚ùå –ù–ï–õ–¨–ó–Ø: –î–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ –ø–∏—à—É—Ç –≤ –æ–¥–∏–Ω message list
```

**–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
> "Agent functions within the same layer cannot communicate via messages. 
> Message output from one layer is only available to functions in subsequent layers."

#### 4.2 –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã message lists

```python
# ‚ùå –ù–ï –ú–û–ì–£–¢ –±—ã—Ç—å –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ:
func_A.setMessageOutput("location")  # –û–±–µ –ø–∏—à—É—Ç –≤ "location"
func_B.setMessageOutput("location")  # ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç!

# ‚úÖ –ú–û–ì–£–¢ –±—ã—Ç—å –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ:
func_A.setMessageOutput("location_A")  # –†–∞–∑–Ω—ã–µ message lists
func_B.setMessageOutput("location_B")  # ‚úÖ OK
```

---

### 5. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ Agent Birth/Death

#### 5.1 Agent Birth (—Å–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤)

```cpp
// –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞—ë—Ç –∞–≥–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ agent_out:
FLAMEGPU->agent_out.setVariable<unsigned int>("idx", new_idx);

‚ùå –ù–ï–õ–¨–ó–Ø –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏, —á–∏—Ç–∞—é—â–∏–º–∏ –∏–∑ —Ç–æ–≥–æ –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:

–§—É–Ω–∫—Ü–∏—è A: –°–æ–∑–¥–∞—ë—Ç –∞–≥–µ–Ω—Ç–æ–≤ –≤ state "operations"
–§—É–Ω–∫—Ü–∏—è B: –ß–∏—Ç–∞–µ—Ç –∏–∑ state "operations"
‚Üí –§—É–Ω–∫—Ü–∏—è B –º–æ–∂–µ—Ç –Ω–µ —É–≤–∏–¥–µ—Ç—å –Ω–æ–≤—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ (–∏–ª–∏ —É–≤–∏–¥–µ—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ)
```

**–ü—Ä–∏–º–µ—Ä –∏–∑ –Ω–∞—à–µ–≥–æ –∫–æ–¥–∞:**
```python
# ‚ùå –ù–ï –ú–û–ì–£–¢ –±—ã—Ç—å –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ:
rtc_spawn_ticket: –°–æ–∑–¥–∞—ë—Ç –∞–≥–µ–Ω—Ç–æ–≤ –≤ "serviceable"
rtc_state_3: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤ –≤ "serviceable"

# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: Spawn –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–ª–æ–µ
layer_spawn = model.newLayer()
layer_spawn.addAgentFunction(rtc_spawn_ticket)  # –°–æ–∑–¥–∞—ë—Ç

layer_processing = model.newLayer()
layer_processing.addAgentFunction(rtc_state_3)  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
```

#### 5.2 Agent Death (—É–¥–∞–ª–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤)

```cpp
// –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç DEAD:
return flamegpu::DEAD;

‚ùå –ù–ï–õ–¨–ó–Ø –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–º–∏ —Ç–æ—Ç –∂–µ agent type:

–§—É–Ω–∫—Ü–∏—è A: –£–¥–∞–ª—è–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç DEAD)
–§—É–Ω–∫—Ü–∏—è B: –ß–∏—Ç–∞–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤ —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞
‚Üí –§—É–Ω–∫—Ü–∏—è B –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —É–∂–µ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤
```

---

### 6. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ HostFunction

#### 6.1 HostFunction –≤ —Å–ª–æ–µ

```python
# ‚úÖ –ú–û–ñ–ù–û: HostFunction –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–ª–æ–µ
layer_host = model.newLayer()
layer_host.addHostFunction(hf_init_mp5)

# ‚ùå –ù–ï–õ–¨–ó–Ø: –ù–µ—Å–∫–æ–ª—å–∫–æ HostFunction –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ
layer_host.addHostFunction(hf_init_mp5)
layer_host.addHostFunction(hf_init_mp4)  # ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç!

# ‚ùå –ù–ï–õ–¨–ó–Ø: HostFunction + AgentFunction –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ
layer_mixed = model.newLayer()
layer_mixed.addHostFunction(hf_init)      # ‚ùå –°–º–µ—à–∏–≤–∞–Ω–∏–µ
layer_mixed.addAgentFunction(rtc_process) # ‚ùå –∑–∞–ø—Ä–µ—â–µ–Ω–æ!
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- HostFunction –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ CPU
- AgentFunction –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ GPU
- –°–º–µ—à–∏–≤–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ CPU‚ÜîGPU

---

### 7. RTC Function Conditions (—É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

#### 7.1 –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Conditions

```python
# RTC Condition ‚Äî —ç—Ç–æ —Ñ–∏–ª—å—Ç—Ä, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –î–û –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
rtc_func.setRTCFunctionCondition(RTC_COND_OPERATIONS)

# Condition –∫–æ–¥:
FLAMEGPU_AGENT_FUNCTION_CONDITION(cond_state_operations) {
    // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true ‚Üí —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –¥–ª—è —ç—Ç–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
    // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç false ‚Üí —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–ø—É—Å—Ç–∏—Ç —ç—Ç–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
    return FLAMEGPU->getVariable<unsigned int>("intent_state") == 2u;
}
```

**–í–∞–∂–Ω–æ:**
- Condition –ù–ï —Å–Ω–∏–º–∞–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ initial/end states!
- Condition ‚Äî —ç—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, –∞ –Ω–µ –∑–∞–º–µ–Ω–∞ state-based –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

**–ü—Ä–∏–º–µ—Ä:**
```python
# ‚ùå –í–°–Å –†–ê–í–ù–û –∫–æ–Ω—Ñ–ª–∏–∫—Ç, –¥–∞–∂–µ —Å condition:
func_A.setInitialState("operations")
func_A.setRTCFunctionCondition("intent == 4")  # –§–∏–ª—å—Ç—Ä –ø–æ intent

func_B.setInitialState("operations")  # ‚ùå –û–±—â–∏–π initial_state!
func_B.setRTCFunctionCondition("intent == 6")

# FLAME GPU –ø—Ä–æ–≤–µ—Ä—è–µ—Ç initial/end state –î–û –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è condition!
```

---

### 8. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ Environment Properties

#### 8.1 PropertyArray vs MacroProperty

```python
# PropertyArray (–Ω–µ–±–æ–ª—å—à–∏–µ –º–∞—Å—Å–∏–≤—ã, <10K —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
env.newPropertyArrayUInt32("mp4_ops_counter", mp4_data)  # –†–∞–∑–º–µ—Ä = DAYS

‚úÖ –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∏–∑ RTC
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è GPU‚ÜîCPU
‚ùå –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —Ä–∞–∑–º–µ—Ä (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ª–∏–º–∏—Ç ~10K-100K —ç–ª–µ–º–µ–Ω—Ç–æ–≤)

# MacroProperty (–±–æ–ª—å—à–∏–µ –º–∞—Å—Å–∏–≤—ã, >100K —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
env.newMacroPropertyUInt32("mp5_lin", MAX_SIZE)  # –†–∞–∑–º–µ—Ä = 286*4001 = 1.1M

‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–≥—Ä–æ–º–Ω—ã—Ö –º–∞—Å—Å–∏–≤–æ–≤
‚úÖ –ñ–∏–≤—ë—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ GPU (–º–∏–Ω–∏–º—É–º CPU‚ÜîGPU —Ç—Ä–∞—Ñ–∏–∫–∞)
‚ùå –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ getMacroProperty() –≤ RTC
‚ùå –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–Ω—É–∂–µ–Ω —è–≤–Ω—ã–π copyout)
```

#### 8.2 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MacroProperty

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ HostFunction
class HF_InitMP5(fg.HostFunction):
    def run(self, FLAMEGPU):
        mp = FLAMEGPU.environment.getMacroPropertyUInt("mp5_lin")
        for i, val in enumerate(self.data):
            mp[i] = int(val)  # –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ CPU

layer_init = model.newLayer()
layer_init.addHostFunction(HF_InitMP5(data, frames, days))

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ RTC
# RTC –Ω–µ –º–æ–∂–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–∏–ª–ª–∏–æ–Ω —ç–ª–µ–º–µ–Ω—Ç–æ–≤
```

---

### 9. –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ª–æ—ë–≤

#### 9.1 –°—Ç—Ä–æ–≥–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å

```python
layer1 = model.newLayer("first")   # –í—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ü–ï–†–í–´–ú
layer2 = model.newLayer("second")  # –í—ã–ø–æ–ª–Ω–∏—Ç—Å—è –í–¢–û–†–´–ú
layer3 = model.newLayer("third")   # –í—ã–ø–æ–ª–Ω–∏—Ç—Å—è –¢–†–ï–¢–¨–ò–ú

# –ü–æ—Ä—è–¥–æ–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ—Ä—è–¥–∫–æ–º —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ—ë–≤!
# –ù–ï–¢ —Å–ø–æ—Å–æ–±–∞ –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏—Ç—å —Å–ª–æ–∏ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
```

**–í–∞–∂–Ω–æ:**
- –ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ—ë–≤ –ø–æ—Å–ª–µ `model.newLayer()`
- –ù–µ–ª—å–∑—è –≤—Å—Ç–∞–≤–∏—Ç—å —Å–ª–æ–π –º–µ–∂–¥—É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏
- –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ—ë–≤ –∑–∞—Ä–∞–Ω–µ–µ!

#### 9.2 –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

```python
# –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –¥–ª—è data dependencies:
–°–ª–æ–π 1: –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–æ–≤     (mask[i] = 0)
–°–ª–æ–π 2: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤  (mask[i] = 1)
–°–ª–æ–π 3: –ß—Ç–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤      (value = mask[i])
–°–ª–æ–π 4: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏–π  (if value == 1: do_action())

# –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫:
–°–ª–æ–π 1: –ß—Ç–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤      ‚ùå –ß–∏—Ç–∞–µ—Ç –º—É—Å–æ—Ä!
–°–ª–æ–π 2: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤
```

---

## üìã –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Ä–µ—à–µ–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

### –ü–∞—Ç—Ç–µ—Ä–Ω 1: –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (Staging States)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç: –æ–±—â–∏–π end_state
func_A: state_1 -> state_2  ‚îê
func_B: state_3 -> state_2  ‚îú‚îÄ end_state = state_2
func_C: state_5 -> state_2  ‚îò
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –°–ª–æ–π 1: –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
func_A: state_1 -> pending_from_1  ‚îê
func_B: state_3 -> pending_from_3  ‚îú‚îÄ ‚úÖ –†–∞–∑–Ω—ã–µ end_state
func_C: state_5 -> pending_from_5  ‚îò

# –°–ª–æ–π 2-4: –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
func_A2: pending_from_1 -> state_2  (—Å–ª–æ–π 2)
func_B2: pending_from_3 -> state_2  (—Å–ª–æ–π 3)
func_C2: pending_from_5 -> state_2  (—Å–ª–æ–π 4)
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –°–æ–±–ª—é–¥–µ–Ω–∏–µ FLAME GPU –ø—Ä–∞–≤–∏–ª
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå +3 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚ùå +1 —Å–ª–æ–π (–∏—Ç–æ–≥–æ 5 –≤–º–µ—Å—Ç–æ 3)
- ‚ùå –£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏

---

### –ü–∞—Ç—Ç–µ—Ä–Ω 2: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º —à–∞–≥–∞–º

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –ö–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω—ã –≤ –æ–¥–Ω–æ–º —à–∞–≥–µ
demount: operations -> serviceable
promote: serviceable -> operations
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ß—ë—Ç–Ω—ã–µ —à–∞–≥–∏: Demount
if (step % 2 == 0):
    operations -> serviceable

# –ù–µ—á—ë—Ç–Ω—ã–µ —à–∞–≥–∏: Promote
if (step % 2 == 1):
    serviceable -> operations
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –ó–∞–¥–µ—Ä–∂–∫–∞ –≤ 1 —à–∞–≥ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚ùå –£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

---

### –ü–∞—Ç—Ç–µ—Ä–Ω 3: Intent-based –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–ù–ê–®–ï –†–ï–®–ï–ù–ò–ï)

**–ò–¥–µ—è:**
- RTC —Ñ—É–Ω–∫—Ü–∏–∏ –ù–ï –º–µ–Ω—è—é—Ç state, —Ç–æ–ª—å–∫–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç `intent_state`
- –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–ª–æ–π State Manager –ø—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
# –°–ª–æ–π 1: State Processing (–≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤ —Å–≤–æ–∏—Ö state)
rtc_state_1: inactive -> inactive       (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç intent=2)
rtc_state_2: operations -> operations   (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç intent=4/6)
rtc_state_3: serviceable -> serviceable (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç intent=2)
# ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤: –≤—Å–µ –æ—Å—Ç–∞—é—Ç—Å—è –≤ —Å–≤–æ–∏—Ö state

# –°–ª–æ–π 2-N: State Managers (–ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏!)
rtc_manager_2_to_4: operations -> repair     (–µ—Å–ª–∏ intent=4)
rtc_manager_2_to_6: operations -> storage    (–µ—Å–ª–∏ intent=6)
rtc_manager_3_to_2: serviceable -> operations(–µ—Å–ª–∏ intent=2)
# ‚ùå –í—Å—ë –µ—â—ë –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã ‚Üí –Ω—É–∂–Ω—ã –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–ª–æ–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ß–∏—Å—Ç–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ intent vs –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ)
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏
- ‚úÖ –õ–µ–≥–∫–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –ù–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤ State Managers
- ‚ùå –í—Å—ë —Ä–∞–≤–Ω–æ –Ω—É–∂–Ω—ã –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–ª–æ–∏ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

---

### –ü–∞—Ç—Ç–µ—Ä–Ω 4: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ–ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏—Ö—Å—è –æ–ø–µ—Ä–∞—Ü–∏–π

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
```python
# ‚úÖ –ú–û–ñ–ù–û –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å:
func_A: state_1 -> state_1  (–æ—Å—Ç–∞—ë—Ç—Å—è)  ‚îê
func_B: state_2 -> state_2  (–æ—Å—Ç–∞—ë—Ç—Å—è)  ‚îú‚îÄ –ù–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π
func_C: state_3 -> state_3  (–æ—Å—Ç–∞—ë—Ç—Å—è)  ‚îò

# ‚úÖ –ú–û–ñ–ù–û –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å:
func_A: state_1 -> state_2  ‚îê
func_B: state_3 -> state_4  ‚îú‚îÄ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
func_C: state_5 -> state_6  ‚îò

# ‚úÖ –ú–û–ñ–ù–û –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å (—Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é):
func_A: state_1 -> state_2  ‚îê
func_B: state_3 -> state_3  ‚îú‚îÄ –ù–µ—Ç –æ–±—â–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
func_C: state_5 -> state_4  ‚îò
```

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–∏—Å–∫–∞:**
1. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
2. –ù–∞–π—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π (–Ω–∏ –ø–æ –≤—Ö–æ–¥—É, –Ω–∏ –ø–æ –≤—ã—Ö–æ–¥—É)
3. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∏—Ö –≤ –æ–¥–∏–Ω —Å–ª–æ–π

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞

### 1. –ß—Ç–æ –ú–û–ñ–ù–û –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å

#### ‚úÖ State Processing: 6 ‚Üí 1 —Å–ª–æ–π
```python
# –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤ —Å–≤–æ–∏—Ö state
state_layer.addAgentFunction(rtc_state_1_inactive)    # 1‚Üí1
state_layer.addAgentFunction(rtc_state_2_operations)  # 2‚Üí2
state_layer.addAgentFunction(rtc_state_3_serviceable) # 3‚Üí3
state_layer.addAgentFunction(rtc_state_4_repair)      # 4‚Üí4
state_layer.addAgentFunction(rtc_state_5_reserve)     # 5‚Üí5
state_layer.addAgentFunction(rtc_state_6_storage)     # 6‚Üí6
```

#### ‚úÖ –ù–µ–ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è transitions: 2 ‚Üí 1 —Å–ª–æ–π
```python
# –†–∞–∑–Ω—ã–µ initial –∏ end states
other_layer.addAgentFunction(rtc_4_to_5)  # repair ‚Üí reserve
other_layer.addAgentFunction(rtc_6_to_6)  # storage ‚Üí storage
```

---

### 2. –ß—Ç–æ –ù–ï–õ–¨–ó–Ø –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å

#### ‚ùå Transitions —Å –æ–±—â–∏–º initial_state
```python
# –ù–ï –ú–û–ì–£–¢ –±—ã—Ç—å –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ:
rtc_2_to_2: operations ‚Üí operations
rtc_2_to_3: operations ‚Üí serviceable
rtc_2_to_4: operations ‚Üí repair
rtc_2_to_6: operations ‚Üí storage
```

**–†–µ—à–µ–Ω–∏–µ:** –û—Å—Ç–∞–≤–∏—Ç—å 4 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–ª–æ—è

#### ‚ùå Transitions —Å –æ–±—â–∏–º end_state
```python
# –ù–ï –ú–û–ì–£–¢ –±—ã—Ç—å –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ:
rtc_1_to_2: inactive ‚Üí operations
rtc_3_to_2: serviceable ‚Üí operations
rtc_5_to_2: reserve ‚Üí operations
```

**–†–µ—à–µ–Ω–∏–µ:** –û—Å—Ç–∞–≤–∏—Ç—å 3 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–ª–æ—è (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å = –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã)

#### ‚ùå Quota pipeline —Å data dependencies
```python
# –ù–ï –ú–û–ì–£–¢ –±—ã—Ç—å –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ:
clear ‚Üí mark ‚Üí decide

# –ö–∞–∂–¥–∞—è —Ñ–∞–∑–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π
```

**–†–µ—à–µ–Ω–∏–µ:** –û—Å—Ç–∞–≤–∏—Ç—å 3 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–ª–æ—è

---

### 3. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

#### –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ–º —Ñ—É–Ω–∫—Ü–∏–π:

```python
def can_combine_in_layer(func_A, func_B):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π –≤ –æ–¥–∏–Ω —Å–ª–æ–π"""
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –û–±—â–∏–π initial_state?
    if func_A.initial_state == func_B.initial_state:
        return False  # ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –û–±—â–∏–π end_state?
    if func_A.end_state == func_B.end_state:
        return False  # ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ü–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–µ A‚ÜíB?
    if func_A.end_state == func_B.initial_state:
        return False  # ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –ü–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–µ B‚ÜíA?
    if func_A.initial_state == func_B.end_state:
        return False  # ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 5: –ò—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ messages?
    if func_A.message_output == func_B.message_output:
        return False  # ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 6: –û–¥–Ω–∞ —Å–æ–∑–¥–∞—ë—Ç –∞–≥–µ–Ω—Ç–æ–≤, –¥—Ä—É–≥–∞—è –∏—Ö —á–∏—Ç–∞–µ—Ç?
    if func_A.creates_agents and func_B.reads_agents:
        if func_A.agent_output_state == func_B.initial_state:
            return False  # ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç
    
    return True  # ‚úÖ –ú–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

### –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **User Guide:** https://docs.flamegpu.com/guide/
- **API Reference:** https://docs.flamegpu.com/api/
- **Tutorial:** https://docs.flamegpu.com/tutorial/

### –ö–ª—é—á–µ–≤—ã–µ —Ä–∞–∑–¥–µ–ª—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- **Layers:** https://docs.flamegpu.com/guide/agent-functions/modelling-behaviour.html#layers
- **Agent States:** https://docs.flamegpu.com/guide/agent-functions/agent-states.html
- **MacroProperty:** https://docs.flamegpu.com/guide/environment/macro-properties.html
- **Messages:** https://docs.flamegpu.com/guide/agent-functions/communication.html

### –ü—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
- **Circles Bruteforce:** –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä —Å messages
- **Predator-Prey:** –ü—Ä–∏–º–µ—Ä —Å agent states
- **Game of Life:** –ü—Ä–∏–º–µ—Ä —Å MacroProperty

---

## ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π

–ü–µ—Ä–µ–¥ –ø—Ä–∏–Ω—è—Ç–∏–µ–º —Ä–µ—à–µ–Ω–∏—è –æ–± –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–ª–æ—ë–≤, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

- [ ] –ù–∞—Ä–∏—Å–æ–≤–∞–ª –≥—Ä–∞—Ñ –≤—Å–µ—Ö state transitions
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª –≤—Å–µ –ø–∞—Ä—ã —Ñ—É–Ω–∫—Ü–∏–π –Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã (4 –ø—Ä–∞–≤–∏–ª–∞)
- [ ] –£—á—ë–ª data dependencies –≤ MacroProperty
- [ ] –£—á—ë–ª message dependencies (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
- [ ] –£—á—ë–ª agent birth/death (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
- [ ] –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ—ë–≤ —Å —É—á—ë—Ç–æ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- [ ] –û—Ü–µ–Ω–∏–ª —Ä–µ–∞–ª—å–Ω—É—é —ç–∫–æ–Ω–æ–º–∏—é (—Å–ª–æ–∏ √ó —à–∞–≥–∏ —Å–∏–º—É–ª—è—Ü–∏–∏)
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª —Ç–µ—Å—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- [ ] –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª –ø—Ä–∏—á–∏–Ω—ã —Ä–µ—à–µ–Ω–∏—è

---

**–ê–≤—Ç–æ—Ä:** AI Agent (Cursor)  
**–î–∞—Ç–∞:** 02-10-2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –¥–ª—è –≤—Å–µ—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π





