# Валидация данных heli_pandas

## Общий принцип

Все агрегаты проходят проверку по набору правил **одновременно**, без вложенных условий и приоритетов.

- **Статусы 10-15** — статусы ошибок и некорректных данных
- **Статусы 1-6** — рабочие статусы (назначаются только если `error_flags = 0`)
- **Статус 0** — новый неучтённый случай (требует расширения валидации)

## Колонки валидации в heli_pandas

| Колонка | Тип | Источник | Описание |
|---------|-----|----------|----------|
| `ll_mi8` | Nullable(UInt32) | md_components | Назначенный ресурс (Life Limit) |
| `oh_mi8` | Nullable(UInt32) | md_components | Межремонтный ресурс (Overhaul) |
| `br_mi8` | Nullable(UInt32) | md_components | Ресурс до ремфонда (Before Repair) |
| `error_flags` | UInt8 | расчётный | Битовая маска ошибок валидации |

## Битовая маска error_flags

| Бит | Значение | Status | Описание |
|-----|----------|--------|----------|
| 0 | 1 | 10 | Недостаточные данные (ll = 0 или NULL) |
| 1 | 2 | 11 | Дата окончания ремонта в прошлом |
| 2 | 4 | 12 | Неисправен при нулевой наработке |
| 3 | 8 | 13 | Превышение ресурса |
| 4 | 16 | 14 | Некорректное значение condition |
| 5 | 32 | 15 | Донор при ремонтопригодном состоянии (warning) |

## Правила валидации (статусы ошибок)

| Status | Флаг | Условие SQL | Описание |
|--------|------|-------------|----------|
| **10** | 1 | `ll_mi8 IS NULL OR ll_mi8 = 0` | Недостаточные данные — ресурс ll не задан |
| **11** | 2 | `target_date < version_date AND target_date IS NOT NULL` | Дата окончания ремонта в прошлом относительно версии данных |
| **12** | 4 | `condition != 'ИСПРАВНЫЙ' AND sne = 0` | Неисправен при нулевой наработке — ошибка данных или заводской брак |
| **13** | 8 | `ll_mi8 > 0 AND (sne > ll_mi8 OR ppr > oh_mi8)` | Превышение ресурса — sne превысил ll или ppr превысил oh |
| **14** | 16 | `condition NOT IN ('ИСПРАВНЫЙ', 'НЕИСПРАВНЫЙ', 'ДОНОР', 'ВОЗМОЖНОЕ ПРОДЛЕНИЕ НР')` | Некорректное значение condition |
| **15** | 32 | `condition = 'ДОНОР' AND br_mi8 > 0 AND sne < br_mi8` | Донор при ремонтопригодном состоянии (предупреждение, не блокирует) |

## Рабочие статусы (1-6)

Назначаются **только** агрегатам с `error_flags = 0`.

| Status | Название | Условие |
|--------|----------|---------|
| 1 | ЭКСПЛУАТАЦИЯ | Исправный, установлен на борт |
| 2 | ХРАНЕНИЕ | Исправный, на складе, sne >= br (неремонтопригодный) |
| 3 | РЕМОНТ | Неисправный, в ремонте |
| 4 | ОЖИДАНИЕ РЕМОНТА | Неисправный, ремфонд (sne < br) |
| 5 | ПОСЛЕ РЕМОНТА | После ремонта, ожидает установки |
| 6 | СПИСАНИЕ | Списан, не участвует в расчётах |

## Валидные значения condition

| Значение | Тип | Описание |
|----------|-----|----------|
| `ИСПРАВНЫЙ` | основной | Агрегат исправен |
| `НЕИСПРАВНЫЙ` | основной | Агрегат неисправен |
| `ДОНОР` | ⚠️ warning | Агрегат-донор для запчастей |
| `ВОЗМОЖНОЕ ПРОДЛЕНИЕ НР` | ⚠️ warning | Агрегат на возможном продлении назначенного ресурса |

> **⚠️ Warning-статусы**: `ДОНОР` и `ВОЗМОЖНОЕ ПРОДЛЕНИЕ НР` — допустимые значения, но требуют особого внимания при анализе. Агрегаты с этими condition проходят валидацию, но могут иметь нестандартное поведение в расчётах.

## Скрипт валидации

Расположение: `code/analysis/validate_heli_pandas.py`

### Использование

```bash
# Только анализ (без изменений в БД)
python code/analysis/validate_heli_pandas.py --analyze

# Обновить ресурсы и пересчитать error_flags
python code/analysis/validate_heli_pandas.py --update

# Всё вместе
python code/analysis/validate_heli_pandas.py --all
```

### Что делает --update

1. Заполняет `ll_mi8`, `oh_mi8`, `br_mi8` из таблицы `md_components` через JOIN по `partseqno_i = partno_comp`
2. Сбрасывает `error_flags = 0`
3. Последовательно устанавливает каждый флаг через `bitOr()` для агрегатов, удовлетворяющих условию

## Пример запроса для проверки

```sql
-- Агрегаты с ошибками
SELECT partno, serialno, condition, sne, ll_mi8, error_flags
FROM heli_pandas
WHERE group_by >= 1 AND error_flags > 0
LIMIT 100;

-- Агрегаты без ошибок (кандидаты на рабочие статусы)
SELECT count(*) FROM heli_pandas
WHERE group_by >= 1 AND error_flags = 0;

-- Декодирование флагов
SELECT 
    partno,
    serialno,
    error_flags,
    bitAnd(error_flags, 1) > 0 AS has_S10,
    bitAnd(error_flags, 2) > 0 AS has_S11,
    bitAnd(error_flags, 4) > 0 AS has_S12,
    bitAnd(error_flags, 8) > 0 AS has_S13,
    bitAnd(error_flags, 16) > 0 AS has_S14,
    bitAnd(error_flags, 32) > 0 AS has_S15
FROM heli_pandas
WHERE group_by >= 1 AND error_flags > 0
LIMIT 20;
```

## История изменений

| Дата | Изменение |
|------|-----------|
| 2024-12-31 | Создание документа. Добавлены колонки ll_mi8, oh_mi8, br_mi8, error_flags в heli_pandas |

