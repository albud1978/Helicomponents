# Экспорт чата от 31-08-2025

## Основные темы чата
- Проверка и фиксация правил LL/OH/BR (минуты) и источников (LL из MP3, OH из MP1) для group_by=1/2
- Квоты эксплуатации: многофазное intent→approve→apply для статусов 2, 3, 5, 1; приоритет 1→2 по минимальному mfg_date
- Логика статуса 4: инкремент repair_days, триггеры partout/assembly (0/1), переход 4→5
- Экспорт симуляции в ClickHouse: создание `sim_results`, батч‑вставка, TRUNCATE для тестов, производные поля и метки
- Диагностика: нули в части триггерных/derived полей после 10‑летнего прогона; постановка P1‑задачи

## Решенные задачи
- Зафиксирована конверсия OH/LL в минуты и устранение двойного ×60 в расчётах BR
- Реализовано квотирование для статуса 2 и фаза распределения для статуса 3; добавлены метрики/логи переходов
- Добавлена фаза квот для статуса 1, с гейтом по `(D+1)−version_date ≥ repair_time` и установкой `active_trigger`, `assembly_trigger`
- Модифицирована логика статуса 4 по требованиям (инкремент/триггеры/переход)
- Внедрён экспорт `sim_results` с постпроцессингом derived полей и `orig_*` сохранением
- Добавлены тайминги `db_insert` для вставки в ClickHouse

## Проблемы и их решения
- Ошибки NVRTC/JIT и seatbelts (macroproperty access, setProperty синтаксис) — исправлены объявления, индексы и синтаксис C++
- Дубликаты логов переходов — устранена повторная фиксация через unique‑фильтр
- `repair_time`=0 в экспортируемых строках — чтение из переменной агента, при отсутствии fallback к MP1
- Оставшиеся нули в полях триггеров/derived после 10‑летнего экспорта — заведена P1‑задача на анализ и исправление

## Изменения в коде
- Обновлён `code/sim_master.py`: DDL `sim_results`, батч‑экспорт, постпроцессинг `s4_derived_*` и меток, тайминги `db_insert`
- Обновлён `code/model_build.py`: переменные агента (intent/active/partout/assembly/partout_time/mfg_date), слои квотирования и статуса 4
- Обновлён `code/sim_env_setup.py`: загрузка MP1 OH по типам, применение в Env

## Обновления документации
- `docs/changelog.md`: добавлен раздел про `sim_results`, флаги экспорта, постпроцессинг, известные проблемы
- `docs/load.md`: описана таблица `sim_results`, DDL, постпроцессинг, флаги CLI, ограничения
- `docs/Tasktracker.md`: зафиксирован P1 — нули в триггерных/derived колонах

## Следующие шаги
- P1: расследовать нули в `partout_time`, `assembly_trigger`, `partout_trigger`, `orig_partout_trigger`, `s4_derived_*`, `*_mark` и исправить
- Актуализировать `docs/GPU.md` при исправлении — зафиксировать точные формулы дат и off‑by‑one
- Повторный 10‑летний экспорт после фикса; сверка метрик и выборочных кейсов

