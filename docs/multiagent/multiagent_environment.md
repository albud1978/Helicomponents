# Мультиагентная среда Helicomponents (messaging)

Документ описывает структуру, роли и правила работы мультиагентной среды, которую мы используем в проекте Helicomponents на ветке `feature/flame-messaging`.

## 1. Назначение и область
- Среда предназначена для разработки, проверки и валидации алгоритмов FLAME GPU с messaging‑архитектурой.
- Рабочие изменения выполняются в `code/`, архивы не трогаем.
- Истина данных — ClickHouse и выгрузка MP2; валидация основана на SQL.

## 2. Источник правил и конфигурация
Единственный источник правил — модульные файлы в `.cursor/rules/*.mdc`. Файл `.cursorrules` — только указатель на эти правила.

Ключевые правила и их зоны:
- `00_global_always.mdc` — глобальные ограничения (типы, ошибки, запреты, ClickHouse).
- `10_extract_and_env.mdc` — окружение, Extract, датасеты, проверки комплектности.
- `20_sim_v2_pipeline.mdc` — симуляция, RTC‑инварианты, NVRTC, порядок прогонов.
- `30_validation_sql_first.mdc` — SQL‑валидация и подход к дебагу.
- `40_docs_and_changelog.mdc` — обязательные документы и консистентность.
- `90_multiagent_workflow.mdc` — роли, последовательный workflow, handoff.

Дополнительные guard‑правила для RTC:
- `.cursor/skills/flame-rtc-guard/SKILL.md` — применять при правках RTC‑кода и messaging‑модулей.

## 3. Роли и зоны ответственности
Роли и зоны соответствуют `90_multiagent_workflow.mdc`.

| Роль | Субагент | Зона | Режим |
|------|----------|------|-------|
| Архитектор | основной агент | `docs/**`, `.cursor/**`, планы | read‑write |
| Кодер | `coder-flame` | `code/sim_v2/messaging/**`, `code/sim_v2/components/**` | read‑write |
| Ревьюер | `reviewer-flame` | весь код | read‑only |
| Валидатор | `validator-judge` | `code/analysis/**`, ClickHouse | read‑only |

## 4. Секвентальный workflow
1. Планирование: пользователь → архитектор (декомпозиция, план).
2. Реализация: архитектор → coder‑flame (бриф) → отчёт и код.
3. Ревью: архитектор → reviewer‑flame → отчёт с замечаниями.
4. Принятие решений: вопросы/эскалация к пользователю при необходимости.
5. Валидация: архитектор → validator‑judge → вердикт PASS/FAIL.
6. Завершение: обновление документации и отчёт пользователю.

## 5. Governance‑gate (контрольная точка)
Обязателен при изменениях архитектуры, алгоритмов или схем данных, а также при выходе за scope.

Структура gate:
- Scope: границы изменений и зависимости.
- Impact: риски и затронутые подсистемы.
- Rules: соответствие правилам `.cursor/rules/*.mdc`, SOLID/DRY/KISS, ограничениям по типам.
- Decision: рекомендация архитектора (APPROVE/REJECT/ESCALATE).

## 6. Отчёты и handoff
Формат отчёта субагента:
1) что сделано
2) что не трогал
3) что проверить (1–3 пункта)
4) риски/вопросы

Handoff‑шаблон (использовать только при передаче между агентами):
- Goal
- Changes
- Evidence (опционально)
- Open Questions
- Risks
- Next Owner

## 7. Ключевые ограничения и запреты
- Архитектурные изменения — только после явного согласования с пользователем.
- Запрещено использовать Float64 без явного разрешения.
- Запрещены «тихие» `try/except`; ошибки обрабатываются явно.
- Запрещено удалять файлы/доки/таблицы без подтверждения пользователя.
- Запрещено запускать симуляции и Extract вне установленных правил.
- Запрещено логирование в RTC без явного согласования.
- NVRTC/JIT warnings недопустимы; при появлении — немедленно исправлять.

## 8. RTC и messaging‑архитектура
- State‑based модель: state меняется только в централизованной функции переходов.
- RTC‑функции состояний выставляют intent‑флаги, но не меняют state.
- Порядок слоёв строгий, согласно матрице состояний.
- Кэширование RTC‑ядер и фиксированные размеры MacroProperty обязательны.
- Для RTC‑правок обязательно применять skill `flame-rtc-guard`.

## 9. Валидация и данные
- Истина — данные в ClickHouse после MP2.
- Валидация выполняется SQL‑запросами, без мутаций.
- Матрица тестов: DAYS={5,90,365,3650}.
- При расхождениях — срез одного дня и сравнение с baseline.

## 10. Артефакты и директории
Основные артефакты среды:
- `config/transitions/**` — правила переходов и контракты.
- `tools/transitions_viewer/**` — viewer для матриц переходов.
- `code/sim_v2/messaging/**` — RTC и messaging‑алгоритмы.
- `code/analysis/**` — валидаторы и SQL‑проверки.
- `docs/validation.md`, `docs/rtc_pipeline_architecture.md`, `docs/changelog.md`, `README.md` — обязательные документы при изменениях кода.

## 11. Ответственность архитектора
- Соблюдение правил и контроль корректности изменений.
- Эскалация к пользователю по критическим вопросам и trade‑offs.
- Согласование архитектуры перед реализацией, если меняется структура или алгоритм.
