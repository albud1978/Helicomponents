## Сессия от 2025-09-19 — статус и итог

### Кратко
- Введён v2 пайплайн (микросервисный подход) с шагами `01..05,99` в `code/sim_v2/`.
- Шаги 01–03 работают: Env загружается, базовая модель собирается, `mp5_lin` читается агентами через `rtc_probe_mp5`.
- В шаге 04 исправлена инициализация статусов: MP5-only → `status_id=0` (резерв); для планёров (group_by∈{1,2}) статусы берутся из MP3. На D0: plane s2=154 (ожидаемо).
- Добавлены строгие валидации (s6 неизменен; Δsne по s2 == сумме dt). На 5 шагах проходят.
- При горизонте 365 выявлена проблема компиляции RTC-функции копирования MP5, когда она расположена в шаге 04. Вывод: копирование должно выполняться строго в шаге 03 один раз; 04 только читает `mp5_lin`.

### Текущее состояние шагов
- `01_setup_env.py`: OK. Загружает MP1/MP3/MP4/MP5, считает `FRAMES`, индексы, валидирует формы и может сохранять снапшот (`tmp/env_snapshot.json`).
- `02_build_model_base.py`: OK. Объявляет Env/Vars; `FRAMES` берётся из снапшота (`frames_union_no_future`).
- `03_add_probe_mp5.py`: OK как испытательный стенд `rtc_probe_mp5`; требуется финализировать как «материализацию MP5»: оставить ТОЛЬКО `rtc_mp5_copy_columns` (фиксированное имя) и одноразовый прогон для копирования `mp5_src → mp5_lin`.
- `04_add_status_246.py`: OK для чтения `mp5_lin`, статусов 2/4/6, логирования и валидирования; УБРАТЬ отсюда любое копирование MP5.
- `05_export_mp5_excel.py`: OK (с чанкингом по листам Excel).
- `99_debug_probe_mp5.py`: OK — изолированный отладчик RTC.

### Инварианты архитектуры v2
- Объявления Env — только в шаге 02.
- Заполнение `mp5_src` с хоста (Python); копирование `mp5_src → mp5_lin` — только шаг 03 одним RTC-ядром `rtc_mp5_copy_columns`.
- Шаги 04+ читают `mp5_lin` (MacroProperty) без записи.
- RTC имена фиксированы: `rtc_mp5_copy_columns`, `rtc_probe_mp5`, `rtc_status_2`, `rtc_status_4`, `rtc_status_6`.
- Индексация MP5: `base = d*FRAMES + i`, `base_next = base + FRAMES`; длина `(DAYS+1)*FRAMES`; тип `UInt32`.

### Открытые задачи
- docs: дописать раздел v2 в `docs/rtc_pipeline_architecture.md` (нумерация шагов, ответственность, инварианты).
- `03_add_probe_mp5.py`: финализировать «материализацию MP5» (только копирование) и убрать из 04 любые копии.
- Долгая проверка 90/365/3650 шагов в строгом режиме; убедиться в переходах 2→6 и эволюции 4→5.
- Excel‑экспорт MP5: дополнить матричным представлением.

### Ссылки
- Архитектура RTC: `docs/rtc_pipeline_architecture.md` (раздел v2 — дополнить).
- Валидации: `docs/validation.md`.

### Примечание
MacroProperty нельзя напрямую заполнить из Python API, поэтому копирование `mp5_src → mp5_lin` выполняется на девайсе один раз (шаг 03). Это техническое требование API.


