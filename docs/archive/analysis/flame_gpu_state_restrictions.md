# Ограничения FLAME GPU для состояний агентов

## Основные ограничения

Из анализа кода FLAME GPU выявлены следующие ограничения для функций в одном слое:

### 1. Запрет на общие состояния в одном слое

Две функции **НЕ МОГУТ** находиться в одном слое, если они имеют:
- **Общее входное состояние** (initial_state)
- **Общее выходное состояние** (end_state)
- **Перекрёстные состояния** (initial_state одной = end_state другой)

### 2. Конкретные проверки в коде

```cpp
if (b->initial_state == f->second->initial_state ||  // Общий вход
    b->initial_state == f->second->end_state ||      // Перекрёстное A
    b->end_state == f->second->initial_state ||      // Перекрёстное B
    b->end_state == f->second->end_state) {          // Общий выход
    THROW exception::InvalidAgentFunc(...);
}
```

### 3. Примеры конфликтов

#### Конфликт общего выхода
```
Функция A: state_1 -> state_2
Функция B: state_3 -> state_2
❌ НЕ могут быть в одном слое (общий end_state = state_2)
```

#### Конфликт общего входа
```
Функция A: state_2 -> state_4
Функция B: state_2 -> state_6
❌ НЕ могут быть в одном слое (общий initial_state = state_2)
```

#### Конфликт перекрёстных состояний
```
Функция A: state_1 -> state_2
Функция B: state_2 -> state_3
❌ НЕ могут быть в одном слое (end_state A = initial_state B)
```

### 4. Допустимые комбинации

```
Функция A: state_1 -> state_2
Функция B: state_3 -> state_4
✅ Могут быть в одном слое (нет общих состояний)
```

## Причины ограничений

1. **Параллелизм GPU**: Все функции в слое выполняются параллельно
2. **Race conditions**: Одновременная запись в одно состояние создаёт гонку данных
3. **Детерминизм**: Обеспечение предсказуемых результатов

## Наши конфликты

### Переходы В operations (общий выход)
```
1 (inactive) -> 2 (operations)
3 (serviceable) -> 2 (operations)  
5 (reserve) -> 2 (operations)
```
❌ Не могут быть в одном слое

### Переходы ИЗ operations (общий вход)
```
2 (operations) -> 4 (repair)
2 (operations) -> 6 (storage)
```
❌ Не могут быть в одном слое

## Дополнительные ограничения

1. **Agent birth**: Функции, создающие агентов, не могут быть в слое с функциями, использующими то же состояние как вход
2. **Message conflicts**: Функции с одинаковыми входными/выходными сообщениями также имеют ограничения
3. **Host functions**: Слой с host function не может содержать другие host functions
