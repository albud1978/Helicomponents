# üèóÔ∏è –ê–ù–ê–õ–ò–ó –ê–†–•–ò–¢–ï–ö–¢–£–†–´ MP2, –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø –ò –í–´–ì–†–£–ó–ö–ò

## üìä –¢–ï–ö–£–©–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê (–∫–∞–∫ —Å–µ–π—á–∞—Å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

```
GPU –°–ò–ú–£–õ–Ø–¶–ò–Ø (3650 —à–∞–≥–æ–≤)
    ‚Üì
    RTC —Å–ª–æ–∏ (state_2_operations, quota_*, state_manager_*)
    ‚Üì
    [–ö–∞–∂–¥—ã–π —à–∞–≥]: –ê–≥–µ–Ω—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
    ‚îú‚îÄ state (—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
    ‚îú‚îÄ intent_state (–∂–µ–ª–∞–µ–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
    ‚îú‚îÄ sne, ppr, repair_days, ...
    ‚îî‚îÄ [–∏ –¥—Ä—É–≥–∏–µ 30+ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö]
    
    ‚Üì
    [–ö–æ–Ω–µ—Ü –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞]: –ó–∞–ø–∏—Å—å –≤ MP2 MacroProperty
    ‚îú‚îÄ –ö–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç ‚Üí MP2[day * FRAMES + idx]
    ‚îî‚îÄ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–∏—à—É—Ç—Å—è –í –ó–ê–®–ò–§–†–û–í–ê–ù–ù–û–ú –ü–û–†–Ø–î–ö–ï (–∫–∞–∫ –æ–Ω–∏ –º–µ–Ω—è—é—Ç—Å—è –≤ RTC)
    
    ‚Üì (–∫–æ–Ω–µ—Ü –≤—Å–µ—Ö 3650 —à–∞–≥–æ–≤)
    ‚Üì
    HOST FUNCTION: MP2DrainHostFunction.run()
    ‚îú‚îÄ –ß–∏—Ç–∞–µ—Ç MP2 —Å GPU
    ‚îú‚îÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç transition_X_to_Y = 0
    ‚îî‚îÄ –í—ã–≥—Ä—É–∂–∞–µ—Ç –≤ ClickHouse
    
    ‚Üì
    HOST FUNCTION: TransitionDetectorHostFunction.run()
    ‚îú‚îÄ –ü—ã—Ç–∞–µ—Ç—Å—è UPDATE —Ç–∞–±–¥–∏—Ü—É –≤ –°–£–ë–î
    ‚îî‚îÄ ‚ùå SQL –º–µ—Ç–æ–¥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí fallback Python
    
    ‚Üì
    –†–ï–ó–£–õ–¨–¢–ê–¢:
    ‚îú‚îÄ sim_masterv2 —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞
    ‚îú‚îÄ –í—Å–µ transition_X_to_Y = 0 (–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã)
    ‚îî‚îÄ ‚ùå –ü–û–¢–ï–†–Ø –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –ü–ï–†–ï–•–û–î–ê–•
```

## ‚úÖ –ü–†–ï–î–õ–ê–ì–ê–ï–ú–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê (GPU POST-PROCESSING)

```
GPU –°–ò–ú–£–õ–Ø–¶–ò–Ø (3650 —à–∞–≥–æ–≤)
    ‚Üì
    RTC —Å–ª–æ–∏ (state_2_operations, quota_*, state_manager_*)
    ‚Üì
    [–ö–∞–∂–¥—ã–π —à–∞–≥]: –ê–≥–µ–Ω—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è + –õ–û–ì–ò–†–£–ï–ú –ü–ï–†–ï–•–û–î–´
    ‚îú‚îÄ state (—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
    ‚îú‚îÄ intent_state (–∂–µ–ª–∞–µ–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
    ‚îú‚îÄ transition_triggered (—Ñ–ª–∞–≥ —Å–º–µ–Ω—ã state)
    ‚îî‚îÄ [–∏ –¥—Ä—É–≥–∏–µ 30+ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö]
    
    ‚Üì (–∫–æ–Ω–µ—Ü –≤—Å–µ—Ö 3650 —à–∞–≥–æ–≤)
    ‚Üì
    [GPU POST-PROCESSING —Å–ª–æ–π - –ü–ï–†–ï–î –≤—ã–≥—Ä—É–∑–∫–æ–π]
    ‚îú‚îÄ –ß–∏—Ç–∞–µ–º MP2 –º–∞—Å—Å–∏–≤—ã –∏–∑ GPU –ø–∞–º—è—Ç–∏
    ‚îú‚îÄ –í–¢–û–†–û–ô –ü–†–û–•–û–î –ü–û MP2:
    ‚îÇ  ‚îî‚îÄ –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ idx:
    ‚îÇ     ‚îú‚îÄ –ü—Ä–æ—à–ª–∏ –ø–æ –¥–Ω—è–º 0..3650
    ‚îÇ     ‚îú‚îÄ –ß–∏—Ç–∞–µ–º state[day] –∏ state[day-1]
    ‚îÇ     ‚îú‚îÄ –ï—Å–ª–∏ state[day] != state[day-1] ‚Üí 
    ‚îÇ     ‚îÇ  ‚îî‚îÄ –ù–∞—Ö–æ–¥–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ transition_X_to_Y
    ‚îÇ     ‚îÇ  ‚îî‚îÄ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤ MP2[day*FRAMES+idx].transition_X_to_Y = 1
    ‚îÇ     ‚îî‚îÄ –ü–∏—à–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ MP2
    ‚îî‚îÄ –†–ï–ó–£–õ–¨–¢–ê–¢: MP2 –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏
    
    ‚Üì
    HOST FUNCTION: MP2DrainHostFunction.run()
    ‚îú‚îÄ –ß–∏—Ç–∞–µ—Ç –ì–û–¢–û–í–´–ô MP2 (—Å –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏)
    ‚îî‚îÄ –í—ã–≥—Ä—É–∂–∞–µ—Ç –≤ ClickHouse –≤ –æ–¥–Ω—É –æ–ø–µ—Ä–∞—Ü–∏—é
    
    ‚Üì
    –†–ï–ó–£–õ–¨–¢–ê–¢:
    ‚îú‚îÄ sim_masterv2 —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –ö–û–†–†–ï–ö–¢–ù–û
    ‚îú‚îÄ –í—Å–µ transition_X_to_Y –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
    ‚îî‚îÄ ‚úÖ –ë–ï–ó –ü–û–¢–ï–†–¨ –ò–ù–§–û–†–ú–ê–¶–ò–ò, –í–°–ï –í GPU
```

## üîç –ß–¢–û –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û –í –¢–ï–ö–£–©–ï–ô –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ó–∞–ø–∏—Å—å –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –ù–£–õ–Ø–ú–ò
- –í `mp2_drain_host.py` (—Å—Ç—Ä–æ–∫–∏ 310-317) –ø–µ—Ä–µ—Ö–æ–¥—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è = 0
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ –¥—Ä–µ–Ω–∞–∂–µ
- TransitionDetectorHostFunction –ø—ã—Ç–∞–µ—Ç—Å—è UPDATE –≤ –°–£–ë–î ‚ùå

### –ü—Ä–æ–±–ª–µ–º–∞ 2: TransitionDetectorHostFunction —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ü–û–°–õ–ï –≤—ã–≥—Ä—É–∑–∫–∏ MP2
- –ü—ã—Ç–∞–µ—Ç—Å—è UPDATE –≥–æ—Ç–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É –≤ ClickHouse
- SQL –º–µ—Ç–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ‚Üí fallback Python
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ—Å—Ç–∞—é—Ç—Å—è 0

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ü–æ—Ç–µ—Ä—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–≥–æ –ø–ª–∞–Ω–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ MP2 –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞ GPU
- –ü–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ GPU
- –í—ã–≥—Ä—É–∑–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ì–û–¢–û–í–´–• –¥–∞–Ω–Ω—ã—Ö –≤ –°–£–ë–î
- –¢–µ–∫—É—â–µ–µ: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ GPU ‚Üí –≤—ã–≥—Ä—É–∑–∫–∞ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö ‚Üí –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ –≤ –°–£–ë–î ‚ùå

## üéØ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø

### –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å state tracking –≤ MP2 –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```cuda
// –í –∫–∞–∂–¥–æ–º RTC —Å–ª–æ–µ state_manager –ø—Ä–∏ —Å–º–µ–Ω–µ state:
mp2_state_prev[day*FRAMES + idx] = mp2_state[day*FRAMES + idx];  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–π state
mp2_state[day*FRAMES + idx] = new_state;                        // –ù–æ–≤—ã–π state
```

### –®–∞–≥ 2: GPU POST-PROCESSING —Å–ª–æ–π –ø–µ—Ä–µ–¥ –¥—Ä–µ–Ω–∞–∂–µ–º
```cuda
// –ù–æ–≤—ã–π RTC —Å–ª–æ–π "compute_transitions" –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –û–î–ò–ù –†–ê–ó –≤ –∫–æ–Ω—Ü–µ —Å–∏–º—É–ª—è—Ü–∏–∏
// –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞:
for (unsigned int day = 1; day <= days_total; day++) {
    unsigned int pos = day * FRAMES + idx;
    unsigned int prev_pos = (day-1) * FRAMES + idx;
    
    unsigned int curr_state = mp2_state[pos];
    unsigned int prev_state = mp2_state[prev_pos];
    
    if (curr_state != prev_state) {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥
        transition = (prev_state << 4) | curr_state;  // e.g., 0x24 = 2->4
        mp2_transition[pos] = compute_transition_flag(transition);
    }
}
```

### –®–∞–≥ 3: –í—ã–≥—Ä—É–∑–∫–∞ –≥–æ—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```python
# MP2DrainHostFunction –ø—Ä–æ—Å—Ç–æ —á–∏—Ç–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:
row = (
    version_date,
    version_id,
    day_u16,
    idx,
    aircraft_number,
    ...
    state,
    mp2_state_prev,  # ‚Üê –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    mp2_transition[pos],  # ‚Üê ‚úÖ –ì–û–¢–û–í–û–ï –∑–Ω–∞—á–µ–Ω–∏–µ!
)
```

## üí° –ß–¢–û –ú–û–ñ–ù–û –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–¢–¨

### –í–∞—Ä–∏–∞–Ω—Ç –ê: –ü–æ–ª–Ω—ã–π GPU –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- ‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ GPU
- ‚úÖ –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- ‚úÖ –û–¥–Ω–∞ –≤—ã–≥—Ä—É–∑–∫–∞ –≤ –°–£–ë–î
- ‚ö†Ô∏è  –¢—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ MP2
- ‚è±Ô∏è ~500ms –Ω–∞ GPU –¥–ª—è –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥–∞ 1M –∑–∞–ø–∏—Å–µ–π

### –í–∞—Ä–∏–∞–Ω—Ç –ë: –ì–∏–±—Ä–∏–¥–Ω—ã–π (–±—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
- –û—Å—Ç–∞–≤–∏—Ç—å MP2 –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∫ –µ—Å—Ç—å
- –î–æ–±–∞–≤–∏—Ç—å state_prev –≤ MP2 —Å—Ç—Ä—É–∫—Ç—É—Ä—É
- GPU –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ –≤—ã—á–∏—Å–ª—è–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥—ã –∏–∑ state –∏ state_prev
- ‚úÖ –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- ‚ö†Ô∏è  –¢—Ä–µ–±—É–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –æ–¥–Ω–æ –ø–æ–ª–µ –≤ MP2

### –í–∞—Ä–∏–∞–Ω—Ç –í: –õ–µ–Ω–∏–≤—ã–π –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ –≤ ClickHouse (—Ç–µ–∫—É—â–∏–π)
- ‚ùå SQL –º–µ—Ç–æ–¥—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚ùå Python fallback –Ω–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
- ‚ùå –¢—Ä–µ–±—É–µ—Ç 2-3 UPDATE –∑–∞–ø—Ä–æ—Å–∞ –ø–æ—Å–ª–µ –≤—ã–≥—Ä—É–∑–∫–∏
- ‚ö†Ô∏è  –û—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ –¥–ª—è 1M –∑–∞–ø–∏—Å–µ–π

