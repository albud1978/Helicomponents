# –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä –º–æ–¥—É–ª—è count_ops

**–î–∞—Ç–∞:** 10.10.2025  
**–ú–æ–¥—É–ª—å:** `rtc_quota_count_ops.py`

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è

`count_ops` ‚Äî —ç—Ç–æ **–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å**, –≤—ã–ø–æ–ª–Ω—è–µ–º—ã–π **–ø–µ—Ä–µ–¥ –≤—Å–µ–º –∫–≤–æ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º**.

### –ó–∞–¥–∞—á–∏:
1. **–û–±–Ω—É–ª–∏—Ç—å** –±—É—Ñ–µ—Ä—ã –ø–æ–¥—Å—á—ë—Ç–∞ –∞–≥–µ–Ω—Ç–æ–≤
2. **–ü–æ–¥—Å—á–∏—Ç–∞—Ç—å** —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≥–µ–Ω—Ç–æ–≤ –≤ `operations`
3. **–ü–æ–¥—Å—á–∏—Ç–∞—Ç—å** —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≥–µ–Ω—Ç–æ–≤ –≤ `serviceable`

### –ó–∞—á–µ–º –Ω—É–∂–Ω–æ?
- –ö–≤–æ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞—Ç—å **Curr** (—Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ operations)
- –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç **—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏** —Ç–æ–ª—å–∫–æ –∞–≥–µ–Ω—Ç–æ–≤ –≤ –Ω—É–∂–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- –ë–µ–∑ —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è –ø–æ–ª—É—á–∞–µ—Ç—Å—è **–Ω–µ–≤–µ—Ä–Ω—ã–π deficit** –∏ **–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π rank**

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è (3 —Å–ª–æ—è)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°–õ–û–ô 1: reset_quota_buffers (operations)                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –ö—Ä–∏—Ç–µ—Ä–∏–π: idx == 0                                              ‚îÇ
‚îÇ –î–µ–π—Å—Ç–≤–∏–µ: –û–±–Ω—É–ª—è–µ—Ç –í–°–ï 4 –±—É—Ñ–µ—Ä–∞ (mi8/mi17 √ó ops/svc)          ‚îÇ
‚îÇ –†–µ–∑—É–ª—å—Ç–∞—Ç: mi8_ops_count[0..285] = 0                           ‚îÇ
‚îÇ            mi17_ops_count[0..285] = 0                           ‚îÇ
‚îÇ            mi8_svc_count[0..285] = 0                            ‚îÇ
‚îÇ            mi17_svc_count[0..285] = 0                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°–õ–û–ô 2: count_ops (operations)                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –ö—Ä–∏—Ç–µ—Ä–∏–π: state == operations (–∞–≥–µ–Ω—Ç –£–ñ–ï –≤ —ç—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏)     ‚îÇ
‚îÇ –î–µ–π—Å—Ç–≤–∏–µ: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥ –≤ –±—É—Ñ–µ—Ä–µ                          ‚îÇ
‚îÇ –†–µ–∑—É–ª—å—Ç–∞—Ç: mi8_ops_count[idx] = 1  (–¥–ª—è Mi-8)                  ‚îÇ
‚îÇ            mi17_ops_count[idx] = 1  (–¥–ª—è Mi-17)                 ‚îÇ
‚îÇ Intent: –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è (—Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ state)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°–õ–û–ô 3: count_serviceable (serviceable)                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –ö—Ä–∏—Ç–µ—Ä–∏–π: state == serviceable (–∞–≥–µ–Ω—Ç –£–ñ–ï –≤ —ç—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏)    ‚îÇ
‚îÇ –î–µ–π—Å—Ç–≤–∏–µ: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥ –≤ –±—É—Ñ–µ—Ä–µ                          ‚îÇ
‚îÇ –†–µ–∑—É–ª—å—Ç–∞—Ç: mi8_svc_count[idx] = 1  (–¥–ª—è Mi-8)                  ‚îÇ
‚îÇ            mi17_svc_count[idx] = 1  (–¥–ª—è Mi-17)                 ‚îÇ
‚îÇ Intent: –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è (—Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ state)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîç –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ –∞–≥–µ–Ω—Ç–∞–º

### ‚úÖ **–¢–û–õ–¨–ö–û —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (state)**

| –°–ª–æ–π | –ö—Ä–∏—Ç–µ—Ä–∏–π | –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ | Intent —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è? |
|------|----------|------------|---------------------|
| **reset_quota_buffers** | `idx == 0` | –õ—é–±–æ–π –∞–≥–µ–Ω—Ç —Å `idx=0` | ‚ùå –ù–ï–¢ |
| **count_ops** | `state == operations` | `group_by`, `idx` | ‚ùå –ù–ï–¢ |
| **count_serviceable** | `state == serviceable` | `group_by`, `idx` | ‚ùå –ù–ï–¢ |

### ‚ö†Ô∏è **Intent –ù–ï —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è!**

**–ü–æ—á–µ–º—É?**
- `intent_state` ‚Äî —ç—Ç–æ **–∂–µ–ª–∞–µ–º–æ–µ** —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∫—É–¥–∞ –∞–≥–µ–Ω—Ç —Ö–æ—á–µ—Ç –ø–æ–ø–∞—Å—Ç—å)
- `state` ‚Äî —ç—Ç–æ **—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ** —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–≥–¥–µ –∞–≥–µ–Ω—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–µ–π—á–∞—Å)
- –ü–æ–¥—Å—á—ë—Ç –Ω—É–∂–µ–Ω –¥–ª—è **Curr** (—Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ), –∞ –Ω–µ –¥–ª—è **–∂–µ–ª–∞–Ω–∏–π**

**–ü—Ä–∏–º–µ—Ä:**
```cpp
// –î–µ–Ω—å 226
Agent 100000: state=serviceable, intent=2 (—Ö–æ—á–µ—Ç –≤ operations)
Agent 10101:  state=operations,   intent=2 (—Ö–æ—á–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è)
Agent 10202:  state=repair,       intent=4 (–≤ —Ä–µ–º–æ–Ω—Ç–µ)

// –†–µ–∑—É–ª—å—Ç–∞—Ç count_ops:
mi17_ops_count[10101] = 1  // ‚úÖ –¢–æ–ª—å–∫–æ 10101 —É—á—Ç—ë–Ω
mi17_ops_count[100000] = 0 // ‚ùå 100000 –ù–ï —É—á—Ç—ë–Ω (state != operations)

// –†–µ–∑—É–ª—å—Ç–∞—Ç count_serviceable:
mi17_svc_count[100000] = 1 // ‚úÖ –¢–æ–ª—å–∫–æ 100000 —É—á—Ç—ë–Ω
mi17_svc_count[10101] = 0  // ‚ùå 10101 –ù–ï —É—á—Ç—ë–Ω (state != serviceable)
```

---

## üßÆ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–≤–æ—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

### 1Ô∏è‚É£ **–ü–æ–¥—Å—á—ë—Ç Curr (Demotion)**

**–§–∞–π–ª:** `rtc_quota_ops_excess.py`

```cpp
// –°—á–∏—Ç–∞–µ–º –†–ï–ê–õ–¨–ù–û–ï –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ operations
auto ops_count = FLAMEGPU->environment.getMacroProperty<unsigned int, 286u>("mi17_ops_count");
unsigned int curr = 0u;
for (unsigned int i = 0u; i < frames; ++i) {
    if (ops_count[i] == 1u) {
        ++curr;  // ‚úÖ –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, –∫—Ç–æ –†–ï–ê–õ–¨–ù–û –≤ operations
    }
}

const int balance = (int)curr - (int)target;  // –ò–∑–±—ã—Ç–æ–∫
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏:**
- `ops_count[i] == 1u` ‚Üí –∞–≥–µ–Ω—Ç —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ **Curr**
- `group_by` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–æ–π –±—É—Ñ–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å (Mi-8 –∏–ª–∏ Mi-17)

---

### 2Ô∏è‚É£ **–†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Demotion (Oldest First)**

**–§–∞–π–ª:** `rtc_quota_ops_excess.py`

```cpp
// –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –¢–û–õ–¨–ö–û —Å—Ä–µ–¥–∏ –∞–≥–µ–Ω—Ç–æ–≤ –≤ operations
auto ops_count = FLAMEGPU->environment.getMacroProperty<unsigned int, 286u>("mi17_ops_count");
unsigned int rank = 0u;

for (unsigned int i = 0u; i < frames; ++i) {
    if (i == idx) continue;
    if (ops_count[i] != 1u) continue;  // ‚úÖ –§–∏–ª—å—Ç—Ä: —Ç–æ–ª—å–∫–æ –∞–≥–µ–Ω—Ç—ã –≤ operations
    
    const unsigned int other_mfg = FLAMEGPU->environment.getProperty<unsigned int>("mp3_mfg_date_days", i);
    if (other_mfg < my_mfg || (other_mfg == my_mfg && i < idx)) {
        ++rank;  // –°—Ç–∞—Ä—à–µ –º–µ–Ω—è ‚Üí —Ä–∞–Ω–≥ —Ä–∞—Å—Ç—ë—Ç
    }
}

if (rank < K) {
    // –Ø –≤ —á–∏—Å–ª–µ K —Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö ‚Üí –¥–µ–º–æ—É–Ω—Ç –≤ serviceable
    FLAMEGPU->setVariable<unsigned int>("intent_state", 3u);
}
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏:**
- `ops_count[i] == 1u` ‚Üí –∞–≥–µ–Ω—Ç —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–∏
- `mfg_date` (–¥–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞) ‚Üí –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É
- **Oldest first:** –º–µ–Ω—å—à–µ `mfg_date` ‚Üí –≤—ã—à–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

---

### 3Ô∏è‚É£ **–†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Promotion (Youngest First)**

**–§–∞–π–ª:** `rtc_quota_promote_serviceable.py`

```cpp
// –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –¢–û–õ–¨–ö–û —Å—Ä–µ–¥–∏ –∞–≥–µ–Ω—Ç–æ–≤ –≤ serviceable
auto svc_count = FLAMEGPU->environment.getMacroProperty<unsigned int, 286u>("mi17_svc_count");
unsigned int rank = 0u;

for (unsigned int i = 0u; i < frames; ++i) {
    if (i == idx) continue;
    if (svc_count[i] != 1u) continue;  // ‚úÖ –§–∏–ª—å—Ç—Ä: —Ç–æ–ª—å–∫–æ –∞–≥–µ–Ω—Ç—ã –≤ serviceable
    
    const unsigned int other_mfg = FLAMEGPU->environment.getProperty<unsigned int>("mp3_mfg_date_days", i);
    if (other_mfg > my_mfg || (other_mfg == my_mfg && i < idx)) {
        ++rank;  // –ú–æ–ª–æ–∂–µ –º–µ–Ω—è ‚Üí —Ä–∞–Ω–≥ —Ä–∞—Å—Ç—ë—Ç
    }
}

if (rank < K) {
    // –Ø –≤ —á–∏—Å–ª–µ K —Å–∞–º—ã—Ö –º–æ–ª–æ–¥—ã—Ö ‚Üí –ø—Ä–æ–º–æ—É—Ç –≤ operations
    FLAMEGPU->setVariable<unsigned int>("intent_state", 2u);
}
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏:**
- `svc_count[i] == 1u` ‚Üí –∞–≥–µ–Ω—Ç —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–∏
- `mfg_date` (–¥–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞) ‚Üí –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É
- **Youngest first:** –±–æ–ª—å—à–µ `mfg_date` ‚Üí –≤—ã—à–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

---

## üìå –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏

### 1. **–û–±–Ω—É–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ idx=0**

```cpp
if (idx == 0u) {
    // –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –∞–≥–µ–Ω—Ç –æ–±–Ω—É–ª—è–µ—Ç –í–°–ï –±—É—Ñ–µ—Ä—ã
    for (unsigned int i = 0u; i < 286u; ++i) {
        mi8_ops[i].exchange(0u);
        mi17_ops[i].exchange(0u);
        mi8_svc[i].exchange(0u);
        mi17_svc[i].exchange(0u);
    }
}
```

**–ü–æ—á–µ–º—É idx=0?**
- –ì–∞—Ä–∞–Ω—Ç–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –û–î–ò–ù —Ä–∞–∑ –∑–∞ —à–∞–≥
- –ò–∑–±–µ–≥–∞–Ω–∏–µ race condition (–±–µ–∑ –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)

---

### 2. **–§–ª–∞–≥–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ .exchange()**

```cpp
ops_count[idx].exchange(1u);  // ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
```

**–ü–æ—á–µ–º—É exchange?**
- MacroProperty —Ç—Ä–µ–±—É–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏
- –ó–∞—â–∏—Ç–∞ –æ—Ç race condition –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –Ω–∞ GPU
- **–ù–ï** –ø—Ä–æ—Å—Ç–æ–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ (`ops_count[idx] = 1u` –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É –∫–æ–º–ø–∏–ª—è—Ü–∏–∏)

---

### 3. **–ë—É—Ñ–µ—Ä—ã –ù–ï —Å—á–∏—Ç–∞—é—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –∞ —Ö—Ä–∞–Ω—è—Ç —Ñ–ª–∞–≥–∏**

```
mi17_ops_count[0..285]:
  [0]=1  ‚Üí Agent —Å idx=0 –≤ operations (Mi-17)
  [1]=1  ‚Üí Agent —Å idx=1 –≤ operations (Mi-17)
  [2]=0  ‚Üí Agent —Å idx=2 –ù–ï –≤ operations
  ...
  [279]=1 ‚Üí Agent —Å idx=279 –≤ operations (Mi-17)
```

**–ü–æ–¥—Å—á—ë—Ç Curr –¥–µ–ª–∞–µ—Ç—Å—è —Ü–∏–∫–ª–æ–º:**

```cpp
unsigned int curr = 0u;
for (unsigned int i = 0u; i < frames; ++i) {
    if (ops_count[i] == 1u) {
        ++curr;
    }
}
```

---

## üîÑ –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. count_ops (3 —Å–ª–æ—è)                                        ‚îÇ
‚îÇ    ‚îú‚îÄ reset_quota_buffers: –æ–±–Ω—É–ª–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤ (idx=0)        ‚îÇ
‚îÇ    ‚îú‚îÄ count_ops:           –ø–æ–¥—Å—á—ë—Ç operations               ‚îÇ
‚îÇ    ‚îî‚îÄ count_serviceable:   –ø–æ–¥—Å—á—ë—Ç serviceable              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 2. state_2_operations                                        ‚îÇ
‚îÇ    - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç intent=2 –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤ –≤ operations        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 3. quota_ops_excess                                          ‚îÇ
‚îÇ    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç mi17_ops_count –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ Curr            ‚îÇ
‚îÇ    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç mi17_ops_count –¥–ª—è —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è (oldest)    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 4. quota_promote_serviceable                                 ‚îÇ
‚îÇ    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç mi17_ops_count –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ Curr            ‚îÇ
‚îÇ    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç mi17_svc_count –¥–ª—è —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è (youngest)  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 5-6. quota_promote_reserve / inactive                        ‚îÇ
‚îÇ    - –ò—Å–ø–æ–ª—å–∑—É—é—Ç mi17_ops_count –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ Curr            ‚îÇ
‚îÇ    - –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—Å–µ–º—É —Å–ª–æ—é (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –±—É—Ñ–µ—Ä–∞–º–∏)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚úÖ –†–µ–∑—é–º–µ: –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ –∞–≥–µ–Ω—Ç–∞–º

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|----------|----------|------------|
| **State** | `operations` –∏–ª–∏ `serviceable` | –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û! –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –≤ –∫–∞–∫–æ–º –±—É—Ñ–µ—Ä–µ —Ñ–ª–∞–≥ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è |
| **Intent** | **–ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è** | Intent –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö, –Ω–æ –Ω–µ –≤ count_ops |
| **group_by** | `1` (Mi-8) –∏–ª–∏ `2` (Mi-17) | –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–æ–π –±—É—Ñ–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å (mi8 –∏–ª–∏ mi17) |
| **idx** | `0..285` | –ò–Ω–¥–µ–∫—Å –∞–≥–µ–Ω—Ç–∞ (–∞–¥—Ä–µ—Å –≤ –±—É—Ñ–µ—Ä–µ) |
| **mfg_date** | –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ count_ops | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–≤–æ—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–ª—è —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è |

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ö–µ–º–∞

```
count_ops –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
  ‚îú‚îÄ –û–±–Ω—É–ª–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤ (idx=0)
  ‚îú‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∫—É —Ñ–ª–∞–≥–æ–≤ –ø–æ –†–ï–ê–õ–¨–ù–û–ú–£ state:
  ‚îÇ    ‚îú‚îÄ operations ‚Üí mi8/mi17_ops_count[idx] = 1
  ‚îÇ    ‚îî‚îÄ serviceable ‚Üí mi8/mi17_svc_count[idx] = 1
  ‚îî‚îÄ –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç intent_state

–ö–≤–æ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
  ‚îú‚îÄ mi8/mi17_ops_count ‚Üí –ø–æ–¥—Å—á—ë—Ç Curr, —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ demotion
  ‚îú‚îÄ mi8/mi17_svc_count ‚Üí —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ promotion P1
  ‚îî‚îÄ –õ–æ–≥–∏–∫–∞: deficit = target - (Curr + Used)
```

**–í—ã–≤–æ–¥:** `count_ops` ‚Äî —ç—Ç–æ **snapshot —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π –∞–≥–µ–Ω—Ç–æ–≤** –Ω–∞ –Ω–∞—á–∞–ª–æ —à–∞–≥–∞, –±–µ–∑ —É—á—ë—Ç–∞ –∏—Ö –∂–µ–ª–∞–Ω–∏–π (intent).

