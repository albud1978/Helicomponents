# Архитектура агрегатов (v2) — переменные и базовые условия

## 1. Сигналы от симуляции планеров

- `aircraft_number` — идентификатор планера
- `planer_state` — статус планера по дням (из `sim_masterv2`)
- `assembly_trigger` — ремонт/сборка (окно, где агрегаты не снимаются)
- `dt` — суточный налёт (инкременты только в `operations`)
- `planer_ac_type_mask` — маска типов для планера

Отладочный кэш в агенте (опционально, временно):
- `planer_state_cache`
- `assembly_trigger_cache`
- `dt_cache`

## 2. Переменные агента агрегата (planned)

| Переменная | Назначение |
| --- | --- |
| `psn` | идентификатор агрегата |
| `group_by` | группа агрегата (3/4) |
| `aircraft_number` | текущая привязка к планеру (0 — нет) |
| `planer_idx` | индекс планера (для доступа к mp‑массивам) |
| `state` | состояние агрегата (`operations/serviceable/repair/storage/...`) |
| `sne` | наработка SNE (общая) |
| `ppr` | наработка PPR (после ремонта) |
| `ll` | лимит ресурса (LL) |
| `oh` | лимит на ремонт (OH) |
| `br` | предел ремонтопригодности (BR) |
| `repair_days` | дни в ремонте |
| `repair_time` | норматив ремонта (из `md_components`) |
| `active` | признак реального агрегата (1) / spawn‑резерва (0) |
| `queue_position` | FIFO‑позиция для выдачи |
| `intent_state` | целевое состояние на шаге |
| `transition_planer_exit` | снятие с планера из‑за выхода из ops |
| `ac_type_mask` | маска типов агрегата (сопоставление с планером) |
| `planer_state_cache` | отладочный кэш статуса планера (опционально) |
| `assembly_trigger_cache` | отладочный кэш сигнала сборки (опционально) |
| `dt_cache` | отладочный кэш налёта (опционально) |

## 3. Базовые условия (rule)

- Планер в `operations` → агрегаты должны быть **при планере** и **исправны** (`operations`).
- Планер в `repair` + `assembly_trigger=1` → агрегаты **не снимаются** и **комплектуются** до нормы.
- Планер вне `operations` → исправные агрегаты могут быть привязаны (`serviceable`) или отвязаны (свободные).
- Инкременты `sne/ppr` только при `planer_state=operations` и `dt>0`.
- Жизненный цикл агрегата первичен: если ресурс исчерпан → агрегат не может быть `operations`/`serviceable`.
- На планер в `operations`/`serviceable` **нельзя** назначать агрегаты не `operations`/`serviceable`.

