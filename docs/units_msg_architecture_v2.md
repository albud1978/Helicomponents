# Архитектура агрегатов (v2) — переменные и базовые условия

## 1. Сигналы от симуляции планеров

- `aircraft_number` — идентификатор планера
- `planer_state` — статус планера по дням (из `sim_masterv2`)
- `assembly_trigger` — ремонт/сборка (окно, где агрегаты не снимаются)
- `dt` — суточный налёт (инкременты только в `operations`)
- `planer_ac_type_mask` — маска типов для планера

Отладочный кэш в агенте (опционально, временно):
- `planer_state_cache`
- `assembly_trigger_cache`
- `dt_cache`

## 2. Переменные агента агрегата (planned)

| Переменная | Назначение |
| --- | --- |
| `psn` | идентификатор агрегата |
| `group_by` | группа агрегата (3/4) |
| `aircraft_number` | текущая привязка к планеру (0 — нет) |
| `planer_idx` | индекс планера (для доступа к mp‑массивам) |
| `state` | состояние агрегата (`operations/serviceable/repair/storage/...`) |
| `sne` | наработка SNE (общая) |
| `ppr` | наработка PPR (после ремонта) |
| `ll` | лимит ресурса (LL) |
| `oh` | лимит на ремонт (OH) |
| `br` | предел ремонтопригодности (BR) |
| `repair_days` | дни в ремонте |
| `repair_time` | норматив ремонта (из `md_components`) |
| `active` | признак реального агрегата (1) / spawn‑резерва (0) |
| `queue_position` | FIFO‑позиция для выдачи |
| `intent_state` | целевое состояние на шаге |
| `transition_planer_exit` | снятие с планера из‑за выхода из ops |
| `ac_type_mask` | маска типов агрегата (сопоставление с планером) |
| `planer_state_cache` | отладочный кэш статуса планера (опционально) |
| `assembly_trigger_cache` | отладочный кэш сигнала сборки (опционально) |
| `dt_cache` | отладочный кэш налёта (опционально) |

## 3. Базовые условия (rule)

- Планер в `operations` → агрегаты должны быть **при планере** и **исправны** (`operations`).
- `assembly_trigger=1` — сигнал финальной сборки: комплектуем **только** `serviceable` агрегатами до нормы.
- Планер вне `operations` → исправные агрегаты могут быть привязаны (`serviceable`) или отвязаны (свободные).
- Инкременты `sne/ppr` только при `planer_state=operations` и `dt>0`.
- Жизненный цикл агрегата первичен: если ресурс исчерпан → агрегат не может быть `operations`/`serviceable`.
- В `storage` допускается **сохранение привязки** (обнуление `aircraft_number` не обязательно).
- На планер в `operations`/`serviceable` **нельзя** назначать агрегаты не `operations`/`serviceable`.

## 4. Маппинг planer_state

- `planer_state` читается из `sim_masterv2` как строковый статус.
- В правилах комплектования учитываются только:
  - `operations`
  - `repair`
- Остальные статусы планера считаются "свободной зоной" (допускается отвязка/перестановка).

## 5. Ограничения на перестановку (aircraft_number)

Изменение `aircraft_number` для агрегата запрещено, если выполняется любое условие:
- `planer_state = operations`
- `assembly_trigger = 1` (окно финальной сборки)
- агрегат уходит из `operations` в любой другой `state` (перестановка блокируется до завершения перехода)

Дополнительно:
- при переходе агрегата в `repair` — `aircraft_number` **обязательно** сбрасывается в `0`.
- в `storage` допускается сохранение привязки, но это отдельное правило менеджера комплектности (см. ниже).

## 6. Совместимость по ac_type_mask

Агрегат может быть назначен на планер только если:
`ac_type_mask & planer_ac_type_mask != 0`.

Несовместимые агрегаты пропускаются и не рассматриваются в пуле на назначение.

## 7. Менеджер комплектности (аналог квотирования)

- Потребность возникает **из анализа комплектности планера**, а не из программы полётов.
- Цель — не только численность, а **комплектация и привязка**:
  - назначение агрегатов на конкретный планер через `aircraft_number`.

### 7.1 Алгоритм (пошагово)

Входы:
- сигналы планера (`planer_state`, `assembly_trigger`, `dt`, `planer_ac_type_mask`)
- состояние агрегатов (`state`, `aircraft_number`, `queue_position`, ресурсы)
- нормативы по комплектности `comp_numbers[group]`

Шаги:
1. Для каждого планера с `planer_state in {operations, repair}`:
   - вычислить текущую комплектность (кол-во агрегатов группы на планере).
   - если `assembly_trigger = 1`, целевая комплектность равна норме.
2. Сформировать дефицит `need = comp_numbers[group] - installed`.
3. Сформировать пул кандидатов:
   - `state = serviceable`
   - `active = 1`
   - совместимы по `ac_type_mask`
   - не заблокированы по условиям перестановки
4. Отсортировать пул:
   - первично по `queue_position` (FIFO)
   - вторично по меньшему `ppr` (меньший износ)
5. Назначить `need` агрегатов:
   - установить `aircraft_number` планера
   - установить `planer_idx`
   - перевести `state -> operations` (только если планер в `operations`)
6. Если пул пуст:
   - в `operations` фиксировать недобор (метрика/лог)
   - не создавать "внезапные" назначения

### 7.2 Приоритеты состояний планера

- `planer_state = operations`:
  - требование: на планере должны быть только `operations/serviceable`
  - инкременты `sne/ppr` агрегатов только если `dt > 0`
- `planer_state = repair`:
  - агрегаты могут быть `serviceable` и ожидать сборки
  - при `assembly_trigger = 1` запрещены любые снятия/перестановки

## 8. Инварианты и проверки

- На планере в `operations` должно быть ровно `comp_numbers[group]` агрегатов.
- В день `dt = 0` агрегаты остаются в `operations`, но инкременты `sne/ppr` = 0.
- Если агрегат перешёл в `repair` — его `aircraft_number` = 0.
- Несовместимые по маске агрегаты не назначаются.

## 9. Обработка исключений

- Несовместимый `ac_type_mask`: агрегат остаётся свободным, логируется как "skipped".
- Пул пуст: дефицит фиксируется, но назначений не делается.
- `assembly_trigger = 1`: любые перестановки блокируются до снятия триггера.

## 10. Таблица переходов агрегатов от состояния планера

> Переходы агрегатов определяются **их собственным циклом** (ресурс, ремонт, storage).
> Состояние планера влияет на привязку и допустимые действия, но не "переписывает" state агрегата.

| Изменение состояния планера | Условия | Действия с агрегатами | Разрешённые состояния агрегатов |
|---|---|---|---|
| `* → operations` | `dt >= 0` | Дособрать до `comp_numbers[group]`, привязать `aircraft_number`, перевод в `operations` | `operations/serviceable` |
| `operations → operations` | `dt > 0` | Инкременты `sne/ppr` | `operations` |
| `operations → serviceable|reserve|inactive|storage` | `assembly_trigger != 1` | Разрешить демоут, агрегаты остаются на месте или отвязываются по менеджеру | `serviceable` (привязка опциональна) |
| `operations → repair` | `assembly_trigger = 1` | Блокировать перестановки, разрешить только комплектование | `serviceable` на планере |
| `repair → serviceable` | `assembly_trigger = 0` | Дособрать до нормы, перевод в `serviceable` | `operations/serviceable` |
| `repair → *` | `assembly_trigger = 1` | Перестановки запрещены | `serviceable` |
| Любое | агрегат уходит в `repair` | Сброс `aircraft_number = 0`, запрет привязки до завершения ремонта | `repair` |
| Любое | агрегат уходит в `storage` | Привязка опциональна (по правилам менеджера) | `storage` |

