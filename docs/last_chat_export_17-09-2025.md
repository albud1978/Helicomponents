# Экспорт чата от 17-09-2025

## Основные темы чата
- Активация ветки spawn в `--status12456-smoke-real` и проверка рождения агентов
- Отладка экспорта: появление новорождённых с D+1, корректность `psn/status_id/group_by/aircraft_number`
- Заполнение новорождённых по MP1: `repair_time/assembly_time/partout_time` и `ll/oh/br`
- Унификация экспорта в ClickHouse: поля `ll`, `oh`, `br` без суффикса `mi17`, инициализация `psn` у стартовых агентов

## Решенные задачи
- Включён надёжный экспорт значений `ll/oh/br` для всех агентов (включая новорождённых)
- Исправлен нулевой `psn` у стартовой популяции: `psn` теперь инициализируется при создании агентов из MP3
- Подтверждён D+1 экспорт для новорождённых (гейт `max_agents=prev_total`)
- Привязка `rt/at/pt` новорождённых к MP1 константам, чтение `ll/oh/br` из MP1 (с учётом типа ВС)

## Проблемы и их решения
- Новые агенты отсутствуют в БД → Экспорт переведён на текущую популяцию (`pop_after`) вместо исходных строк
- Агенты появлялись с D0 → Введён D+1 гейт при экспорте (исключение новорождённых дня d)
- `psn/status_id` были 0 → Добавлено чтение `psn`/`status_id` строго из агентных переменных; диагностика логами рождений
- `ll/oh/br` в БД нули при наличии в логе → Исправлено чтение в экспорте (надёжный `try/except` вместо `"name" in dir(ag)`) и подтверждено заполнение
- Неопределённость полей MP1 → Динамический выбор имён колонок в запросах к `md_components`

## Изменения в коде
- Обновлён `code/sim_master.py`:
  - Экспорт: надёжное чтение `ll/oh/br/sne/ppr` через `try/except`
  - D+1 гейт: `export_day_snapshot(..., max_agents=prev_total)` для ветки без постпроцессинга
  - Инициализация `psn` у стартовой популяции из MP3 в `--status12456-smoke-real`
- Обновлён `code/model_build.py`:
  - ENV-константы: `mi17_br_const/mi17_ll_const/mi17_oh_const` + установка переменных новорождённых в `rtc_spawn_mi17_atomic`
- Обновлён `code/sim_env_setup.py` (ранее):
  - Динамический выбор колонок MP1 для `repair_time/partout_time/assembly_time` и `ll_mi17/oh_mi17/br_mi17`

Ссылки на файлы:
- `code/sim_master.py`
- `code/model_build.py`
- `code/sim_env_setup.py`

## Обновления документации
- Добавлена запись в `docs/changelog.md` за 17-09-2025 (фиксы экспорта `ll/oh/br`, инициализация `psn` у стартовых агентов, D+1)
- Обновлён `docs/migration.md`: добавлены ENV-константы и правила экспорта `ll/oh/br/psn`

## Следующие шаги
- Провести SQL-проверку в ClickHouse для выборки `ll/oh/br` и `psn` на D+1 для новорождённых и на D0/D+ для стартовых агентов
- Зафиксировать инварианты типов данных (UInt32 для `ll/oh/br`, UInt32 для `psn`) и диапазоны в документации
- При необходимости вернуться к единому MP2 copyout после переноса постпроцессинга на GPU
