# Validation (V2)

## Статусы и проверки

- Status 2 (эксплуатация)
  - Инкременты: sne += dt, ppr += dt, где dt = mp5(day, idx).
  - Прогноз: s_next = sne + dn, p_next = ppr + dn.
  - Переходы:
    - 2→6 при s_next >= ll (LL порог), s6_days=0, s6_started=1.
    - 2→4 при p_next >= oh и s_next < br (BR/repair ветка).

- Status 4 (ремонт)
  - repair_days растёт до repair_time.
  - Переход 4→5 при достижении repair_days >= repair_time.
  - assembly_time влияет на маркер сборки (планово D‑assembly_time до конца ремонта).

- Status 6 (хранение)
  - «Вечный»: значения повторяются, s6_days растёт только если s6_started=1.

## Логирование для smoke

- Итоговые счётчики по статусам: s2/s4/s6.
- Выборка нескольких бортов: (idx, status, sne, ppr, ll, oh, dt, dn).
- Трассировка одного idx по дням: (day, idx, dt, dn, sne, ppr, status).

## Источники данных

- MP5: линейный массив (DAYS+1)*FRAMES с паддингом, MacroProperty mp5_lin.
- MP3 пороги: ll, oh, br — сопоставлены по frames_index.

## Инварианты

- Длины массивов соответствуют DAYS/FRAMES.
- Индексация row = day*FRAMES + idx; row_next = row + FRAMES.
- Типы согласованы: UInt32 для MP5 и агентных накопителей.

## Правило источников данных (строго)

- Все тесты/прогоны выполняются ТОЛЬКО на реальных данных из ClickHouse.
- Использование синтетических/генерируемых данных, заглушек или ручных подмен — запрещено без явного разрешения владельца (Алексея) в текущем чате.
- Любые отступления фиксируются в документации c указанием причины и сроком возврата к реальным данным.

## V2 State-based архитектура (добавлено 25-09-2025)

### Результаты длительных прогонов

**Прогон на 3650 дней (10 лет):**
- Начальное состояние: 154 operations, 7 repair, 118 inactive
- Финальное состояние: 2 operations, 97 repair, 62 storage, 118 inactive
- Переходы работают корректно: агенты переходят в repair при достижении OH и в storage при достижении BR
- Два агента остались в operations из-за низкого суточного налета (dt=2 и dt=29)
- Производительность: ~13.4мс на шаг, общее время 54.44с
- MP2 экспорт: 11 операций дренажа, ~275K записей экспортировано

### Инварианты состояний
- **Intent всегда определен**: `intent_state != 0` для всех агентов на всех шагах
- **Корректность переходов**: Агент может перейти только в состояние, указанное в intent_state
- **Отсутствие каскадных переходов**: За один шаг агент переходит максимум один раз

### Инварианты MP5 в V2
- **Индексация**: `base = step_day * MAX_FRAMES + idx` (не `idx * (MAX_DAYS + 1) + step_day`)
- **Размер**: `mp5_lin` содержит `(MAX_DAYS + 1) * MAX_FRAMES` элементов
- **Read-only после инициализации**: MP5 не изменяется RTC функциями

### Валидация переходов из operations
- **Приоритет проверок**: LL → OH+BR → остаемся в operations
- **Условия перехода в repair**: `ppr_next >= oh AND sne_next < br`
- **Условия перехода в storage**: `sne_next >= ll OR (ppr_next >= oh AND sne_next >= br)`
- **Расчет прогноза**: `s_next = sne + dn`, `p_next = ppr + dn` (без двойного учета dt)
- **Side effects при operations**: 
  - Если active_trigger=1 → сбрасываем в 0
  - Если assembly_trigger=0 → устанавливаем в 1
  - При переходе 2→4: ppr сбрасывается в 0
  - При переходе 2→6: устанавливается s6_started = step_day

