# üî¨ –≠–ö–°–ü–ï–†–¢–ù–´–ô –ê–ù–ê–õ–ò–ó: –õ–æ–≥–∏–∫–∞ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –¥–µ–º–æ—É—Ç–∞ (oldest first)

## ‚öôÔ∏è –®–ê–ì 1: –°–û–†–¢–ò–†–û–í–ö–ê –í ETL (build_frames_index)

### –ö–æ–¥ –≤ `code/sim_env_setup.py` (—Å—Ç—Ä–æ–∫–∏ 196-263):

```python
def build_frames_index(mp3_rows, mp3_fields: List[str]) -> Tuple[Dict[int, int], int]:
    """
    –°—Ç—Ä–æ–∏—Ç frames_index —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ mfg_date (—Å—Ç–∞—Ä—ã–µ –ø–µ—Ä–≤—ã–µ)
    –†–∞–∑–¥–µ–ª—è–µ—Ç –Ω–∞ Mi-8 –∏ Mi-17: —Å–Ω–∞—á–∞–ª–∞ –≤—Å–µ Mi-8 –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É, –ø–æ—Ç–æ–º –≤—Å–µ Mi-17
    """
```

### –ö–õ–Æ–ß–ï–í–û–ô –ú–û–ú–ï–ù–¢: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –≤ ETL

```python
# –°–æ–±–∏—Ä–∞–µ–º –ø–ª–∞–Ω–µ—Ä—ã –ø–æ —Ç–∏–ø–∞–º
planes_mi8 = []  # (aircraft_number, mfg_date_days)
planes_mi17 = []

for r in mp3_rows:
    gb = int(r[idx['group_by']] or 0)
    if gb not in (1, 2):
        continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ-–ø–ª–∞–Ω–µ—Ä—ã
    
    mfg_date_days = ...  # –ø–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
    
    if gb == 1:
        planes_mi8.append((ac, mfg_date_days))
    elif gb == 2:
        planes_mi17.append((ac, mfg_date_days))

# –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ mfg_date (—Å—Ç–∞—Ä—ã–µ –ø–µ—Ä–≤—ã–µ)
planes_mi8_unique = {ac: mfg for ac, mfg in planes_mi8}
planes_mi17_unique = {ac: mfg for ac, mfg in planes_mi17}

sorted_mi8 = sorted(planes_mi8_unique.items(), key=lambda x: (x[1], x[0]))  # (mfg_date, ac)
sorted_mi17 = sorted(planes_mi17_unique.items(), key=lambda x: (x[1], x[0]))

# ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –°–Ω–∞—á–∞–ª–∞ –≤—Å–µ Mi-8, –ø–æ—Ç–æ–º –≤—Å–µ Mi-17
ac_list_sorted = [ac for ac, _ in sorted_mi8] + [ac for ac, _ in sorted_mi17]

# –°–æ–∑–¥–∞—ë–º frames_index: aircraft_number ‚Üí frame_idx (–æ–Ω –∂–µ idx –¥–ª—è –∞–≥–µ–Ω—Ç–∞)
frames_index = {ac: i for i, ac in enumerate(ac_list_sorted)}
```

### –†–ï–ó–£–õ–¨–¢–ê–¢ –ø–æ—Å–ª–µ ETL:

```
frame_idx (= idx –∞–≥–µ–Ω—Ç–∞)    aircraft_number    group_by    mfg_date
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
0                          24103 (Mi-8)         1          2281
1                          22607 (Mi-8)         1          3733
2                          22633 (Mi-8)         1          3829
...
54                         22876 (Mi-8)         1          6160
...
278                        25500 (Mi-17)        2          5320
279                        25501 (Mi-17)        2          6200
280                        25502 (Mi-17)        2          6300
```

**–ì–ê–†–ê–ù–¢–ò–Ø:** `idx` –í–°–ï–ì–î–ê –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ `mfg_date`:
- –º–µ–Ω—å—à–∏–π idx = –°–¢–ê–†–®–ï (—Ä–∞–Ω—å—à–µ –ø—Ä–æ–∏–∑–≤–µ–¥—ë–Ω)
- –±–æ–ª—å—à–∏–π idx = –ú–û–õ–û–ñ–ï (–ø–æ–∑–∂–µ –ø—Ä–æ–∏–∑–≤–µ–¥—ë–Ω)
- **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞—Ä—É—à–∞–µ—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –≤–Ω—É—Ç—Ä–∏ —Ç–∏–ø–∞**

---

## ‚öôÔ∏è –®–ê–ì 2: –°–û–ó–î–ê–ù–ò–ï –ê–ì–ï–ù–¢–û–í (agent_population.py)

### –ö–æ–¥ –≤ `code/sim_v2/components/agent_population.py` (—Å—Ç—Ä–æ–∫–∏ 144-157):

```python
# –ò—Å–ø–æ–ª—å–∑—É–µ–º frame_idx –∫–∞–∫ idx –∞–≥–µ–Ω—Ç–∞ (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —É–∂–µ —Å–¥–µ–ª–∞–Ω–∞ –≤ ETL)
for frame_idx, agent_data in sorted_records:
    # ...
    agent.setVariableUInt("idx", frame_idx)
    agent.setVariableUInt("aircraft_number", agent_data['aircraft_number'])
    agent.setVariableUInt("group_by", agent_data['group_by'])
    # ...
```

**–ì–ê–†–ê–ù–¢–ò–Ø:** –ê–≥–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç `idx = frame_idx` **–ë–ï–ó –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ò –ò–ù–î–ï–ö–°–ê**

```
–ê–≥–µ–Ω—Ç —Å aircraft_number=24103 (Mi-8):
  idx = 0
  group_by = 1
  mfg_date = 2281
```

---

## ‚öôÔ∏è –®–ê–ì 3: –ü–û–î–°–ß–Å–¢ –í RTC (rtc_quota_count_ops)

### –õ–æ–≥–∏–∫–∞ –≤ `rtc_quota_count_ops.py`:

```cpp
// –°–ª–æ–π 1: RESET - —Ç–æ–ª—å–∫–æ idx=0 —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –±—É—Ñ–µ—Ä—ã
if (idx == 0u) {
    for (unsigned int i = 0u; i < 286u; ++i) {
        mi8_ops[i].exchange(0u);  // MacroProperty –±—É—Ñ–µ—Ä—ã
        mi17_ops[i].exchange(0u);
    }
}

// –°–ª–æ–π 2: COUNT - –∫–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç –ø–∏—à–µ—Ç 1 –≤ —Å–≤–æ—é —è—á–µ–π–∫—É
if (intent == 2u) {  // –†–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å operations
    if (group_by == 1u) {
        auto ops_count = FLAMEGPU->environment.getMacroProperty<unsigned int, 286u>("mi8_ops_count");
        ops_count[idx].exchange(1u);  // ‚úÖ –ü–∏—à–µ–º –≤ ops_count[idx]=1
    }
    // ...
}
```

**–†–ï–ó–£–õ–¨–¢–ê–¢:** `ops_count[]` –±—É—Ñ–µ—Ä —Å–æ–¥–µ—Ä–∂–∏—Ç:

```
ops_count[0] = 1   (–µ—Å–ª–∏ AC 24103 –≤ operations)
ops_count[1] = 1   (–µ—Å–ª–∏ AC 22607 –≤ operations)
ops_count[54] = 0  (–µ—Å–ª–∏ AC 22876 –ù–ï –≤ operations)
...
ops_count[279] = 1 (–µ—Å–ª–∏ AC 25500 (Mi-17) –≤ operations)
```

---

## üéØ –®–ê–ì 4: –î–ï–ú–û–£–¢ ‚Äî –†–ê–ù–ñ–ò–†–û–í–ê–ù–ò–ï (rtc_quota_ops_excess)

### –í–•–û–î –≤ –¥–µ–º–æ—É—Ç (–î–µ–Ω—å 180):

```
Curr (–≤ operations):
  Mi-8: ops_count[] –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 108 –∞–≥–µ–Ω—Ç–æ–≤ –≤ operations
  –¶–µ–ª–∏–∫–æ–º: idx 0..107 (–Ω—É–º–µ—Ä–∞—Ü–∏—è —É—Å–ª–æ–≤–Ω–∞—è) –∏–º–µ—é—Ç ops_count[i]=1

Target: mp4_ops_counter_mi8[181] = 100  (–Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å)

Balance = Curr - Target = 108 - 100 = 8
  ‚Üí –ù—É–∂–Ω–æ –¥–µ–º–æ—É—Ç–∏—Ä–æ–≤–∞—Ç—å K=8 —Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤
```

### –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –§–†–ê–ì–ú–ï–ù–¢ –ö–û–î–ê (—Å—Ç—Ä–æ–∫–∏ 88-111):

```cpp
unsigned int rank = 0u;

if (group_by == 1u) {
    auto ops_count = FLAMEGPU->environment.getMacroProperty<unsigned int, 286u>("mi8_ops_count");
    for (unsigned int i = 0u; i < frames; ++i) {
        if (i == idx) continue;                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–µ–±—è
        if (ops_count[i] != 1u) continue;          // ‚úÖ –¢–æ–ª—å–∫–æ –∞–≥–µ–Ω—Ç—ã –≤ operations
        
        // Oldest first: rank —Ä–∞—Å—Ç—ë—Ç –µ—Å–ª–∏ other (i) –°–¢–ê–†–®–ï –º–µ–Ω—è (–º–µ–Ω—å—à–∏–π idx)
        if (i < idx) {  // ‚Üê –≠–¢–û –ö–õ–Æ–ß–ï–í–ê–Ø –°–¢–†–û–ö–ê
            ++rank;
        }
    }
}

if (rank < K) {
    // –Ø –≤ —á–∏—Å–ª–µ K —Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö ‚Üí –¥–µ–º–æ—É—Ç
    FLAMEGPU->setVariable<unsigned int>("intent_state", 3u);
    // ...
}
```

### –¢–†–ê–°–°–ò–†–û–í–ö–ê –õ–û–ì–ò–ö–ò (–î–µ–Ω—å 180, –¥–µ–º–æ—É—Ç Mi-8, K=8):

#### –ê–≥–µ–Ω—Ç: idx=0, AC 24103 (—Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π)

```cpp
rank = 0
for i in [0, ..., 285]:
    if (i == 0) continue;              // i=0 –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    if (ops_count[i] != 1) continue;   // –¢–æ–ª—å–∫–æ —Å ops_count=1
    
    if (i < 0) ++rank;  // ‚úÖ –í–°–ï–ì–î–ê FALSE (i ‚â• 0)

// rank = 0
// rank (0) < K (8) ‚Üí ‚úÖ –î–ï–ú–û–£–¢ ‚úÖ (—Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π)
```

#### –ê–≥–µ–Ω—Ç: idx=54, AC 22876 (54-–π –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É —Å—Ä–µ–¥–∏ Mi-8)

```cpp
rank = 0
for i in [0, ..., 285]:
    if (i == 54) continue;
    if (ops_count[i] != 1) continue;
    
    if (i < 54) {
        // i=0: ops_count[0]=1 ‚Üí ++rank  ‚Üí rank=1
        // i=1: ops_count[1]=1 ‚Üí ++rank  ‚Üí rank=2
        // ...
        // i=53: ops_count[53]=1 ‚Üí ++rank ‚Üí rank=54
    }

// rank = 54 (–µ—Å–ª–∏ –≤—Å–µ 54 –∞–≥–µ–Ω—Ç–∞ —Å—Ç–∞—Ä—à–µ –≤ operations)
// rank (54) < K (8) ‚Üí ‚úÖ FALSE ‚Üí –ù–ï –î–ï–ú–û–£–¢ ‚úÖ
```

#### –ê–≥–µ–Ω—Ç: idx=100, AC XXXXX (100-–π –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É)

```cpp
rank = 0
for i in [0, ..., 285]:
    if (ops_count[i] != 1) continue;  // –¢–æ–ª—å–∫–æ –≤ operations
    if (i < 100) {
        // –ï—Å–ª–∏ 7 –∞–≥–µ–Ω—Ç–æ–≤ (idx 0..6) –≤ operations ‚Üí rank=7
        // –ï—Å–ª–∏ –∞–≥–µ–Ω—Ç 99 –ù–ï –≤ operations ‚Üí rank –æ—Å—Ç–∞—ë—Ç—Å—è 7
    }

// –ï—Å–ª–∏ –≤ operations: 0, 1, 2, 3, 4, 5, 6, 100, 101, ... (–≤—Å–µ–≥–æ 8)
// rank = 7
// rank (7) < K (8) ‚Üí ‚úÖ –î–ï–ú–û–£–¢ ‚úÖ (8-–π –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É)

// –ï—Å–ª–∏ –≤ operations: 0, 1, 2, 3, 4, 5, 6, 7, 100, 101, ... (–≤—Å–µ–≥–æ 9)
// rank = 8
// rank (8) < K (8) ‚Üí ‚úÖ FALSE ‚Üí –ù–ï –î–ï–ú–û–£–¢ ‚úÖ
```

---

## üîç –ê–ù–ê–õ–ò–ó –ö–û–†–†–ï–ö–¢–ù–û–°–¢–ò:

### ‚úÖ –ò–ù–í–ê–†–ò–ê–ù–¢ 1: –î–µ–º–æ—É—Ç –≤—Å–µ–≥–¥–∞ –≤—ã–±–∏—Ä–∞–µ—Ç K —Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö

```
–õ–µ–º–º–∞: –∞–≥–µ–Ω—Ç i –¥–µ–º–æ—É—Ç–∏—Ä—É–µ—Ç—Å—è –µ—Å–ª–∏ –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
  1. intent = 2 (–≤ operations)
  2. ops_count[i] = 1
  3. rank(i) < K, –≥–¥–µ rank(i) = |{j : j < i AND ops_count[j] = 1}|

–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:
- rank(i) —Å—á–∏—Ç–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≥–µ–Ω—Ç–æ–≤ –°–¢–ê–†–®–ï i (j < i) –≤ operations
- rank(i) < K –æ–∑–Ω–∞—á–∞–µ—Ç –∞–≥–µ–Ω—Ç i –≤ —á–∏—Å–ª–µ K –ø–µ—Ä–≤—ã—Ö –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É
- –¢.–µ. –¥–µ–º–æ—É—Ç–∏—Ä—É—é—Ç—Å—è K —Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö ‚úÖ
```

### ‚úÖ –ò–ù–í–ê–†–ò–ê–ù–¢ 2: –î–µ–º–æ—É—Ç —Ä–æ–≤–Ω–æ K –∞–≥–µ–Ω—Ç–æ–≤ (–Ω–µ –º–µ–Ω–µ–µ, –Ω–µ –±–æ–ª–µ–µ)

```
–õ–µ–º–º–∞: —Ä–æ–≤–Ω–æ K –∞–≥–µ–Ω—Ç–æ–≤ –∏–º–µ—é—Ç rank < K

–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:
- rank(0) = 0 < K ‚Üí –∞–≥–µ–Ω—Ç 0 –¥–µ–º–æ—É—Ç–∏—Ä—É–µ—Ç—Å—è ‚úÖ
- rank(1) = 1 < K ‚Üí –∞–≥–µ–Ω—Ç 1 –¥–µ–º–æ—É—Ç–∏—Ä—É–µ—Ç—Å—è ‚úÖ
- ...
- rank(K-1) = K-1 < K ‚Üí –∞–≥–µ–Ω—Ç K-1 –¥–µ–º–æ—É—Ç–∏—Ä—É–µ—Ç—Å—è ‚úÖ
- rank(K) = K ‚âÆ K ‚Üí –∞–≥–µ–Ω—Ç K –ù–ï –¥–µ–º–æ—É—Ç–∏—Ä—É–µ—Ç—Å—è
- rank(K+1) = K+1 ‚âÆ K ‚Üí –∞–≥–µ–Ω—Ç K+1 –ù–ï –¥–µ–º–æ—É—Ç–∏—Ä—É–µ—Ç—Å—è
- ...

–ò—Ç–æ–≥–æ: —Ä–æ–≤–Ω–æ K –∞–≥–µ–Ω—Ç–æ–≤ (0..K-1) –¥–µ–º–æ—É—Ç–∏—Ä—É–µ—Ç—Å—è ‚úÖ
```

### ‚úÖ –ò–ù–í–ê–†–ò–ê–ù–¢ 3: –ü–æ—Ä—è–¥–æ–∫ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –Ω–µ –≤–∞–∂–µ–Ω (–∫–æ–º–ø–ª–µ–∫—Ç –æ–¥–∏–Ω–∞–∫–æ–≤)

```
–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
- –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –¢–û–õ–¨–ö–û –æ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ idx
- ops_count[i] —Å—Ç–∞—Ç–∏—á–µ–Ω –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–¥–Ω–æ–≥–æ —Å–ª–æ—è
- –ü–æ—Ä—è–¥–æ–∫ –∏—Ç–µ—Ä–∞—Ü–∏–∏ i –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ rank
- –í—Å–µ –∞–≥–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—Ç –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –∑–Ω–∞—á–µ–Ω–∏–µ rank
- –ö–æ–º–ø–ª–µ–∫—Ç K –¥–µ–º–æ—É—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö = –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ
```

---

## üí• –°–†–ê–í–ù–ï–ù–ò–ï –° –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ô –õ–û–ì–ò–ö–û–ô (–∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ –î–û):

### ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (if i > idx):

```cpp
// ‚ùå –ë–´–õ–û:
unsigned int rank = 0u;
for (unsigned int i = 0u; i < frames; ++i) {
    if (i == idx) continue;
    if (ops_count[i] != 1u) continue;
    
    if (i > idx) {  // ‚Üê –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: —Å—á–∏—Ç–∞–µ—Ç –ë–û–õ–ï–ï –ú–û–õ–û–î–´–•
        ++rank;
    }
}

if (rank < K) {  // –ê–≥–µ–Ω—Ç—ã —Å –º–∞–ª—ã–º rank = –º–∞–ª–æ –∫—Ç–æ –º–æ–ª–æ–∂–µ = –ú–û–õ–û–î–´–ï
    // ‚ùå –î–ï–ú–û–£–¢ –ú–û–õ–û–î–´–• –í–ú–ï–°–¢–û –°–¢–ê–†–´–•!
}
```

#### –ü—Ä–∏–º–µ—Ä (–î–µ–Ω—å 180, K=8):

```
idx=100, AC XXXXX:
  for i in [101, 102, ..., 285]:
    if (ops_count[i] != 1) continue;
  
  –ï—Å–ª–∏ –≤ operations: [0, 1, 2, 3, 4, 5, 6, 100, 101, 102, 103, 104, 105, 106, 107]
  (–≤—Å–µ–≥–æ 15 –≤ operations)
  
  rank = 7 (–∞–≥–µ–Ω—Ç—ã 101..107 —ç—Ç–æ —Ç–µ —á—Ç–æ –º–æ–ª–æ–∂–µ –∏ –≤ operations)
  rank (7) < K (8) ‚Üí ‚ùå –î–ï–ú–û–£–¢ (–º–æ–ª–æ–¥–æ–π!)
  
  –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –¥–µ–º–æ—É—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä–æ–≥–æ (idx=0), –¥–µ–º–æ—É—Ç–∏—Ä—É–µ—Ç—Å—è –º–æ–ª–æ–¥–æ–π (idx=100)!
```

---

## ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê (–¢–ï–ö–£–©–ê–Ø):

```cpp
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û (if i < idx):
unsigned int rank = 0u;
for (unsigned int i = 0u; i < frames; ++i) {
    if (i == idx) continue;
    if (ops_count[i] != 1u) continue;
    
    if (i < idx) {  // ‚úÖ –°—á–∏—Ç–∞–µ—Ç –ë–û–õ–ï–ï –°–¢–ê–†–´–•
        ++rank;
    }
}

if (rank < K) {  // –ê–≥–µ–Ω—Ç—ã —Å –º–∞–ª—ã–º rank = –º–∞–ª–æ –∫—Ç–æ —Å—Ç–∞—Ä—à–µ = –°–¢–ê–†–´–ï
    // ‚úÖ –î–ï–ú–û–£–¢ –°–¢–ê–†–´–• –ü–†–ê–í–ò–õ–¨–ù–û!
}
```

#### –ü—Ä–∏–º–µ—Ä (–î–µ–Ω—å 180, K=8):

```
idx=100, AC XXXXX:
  for i in [0, 1, ..., 99]:
    if (ops_count[i] != 1) continue;
  
  –ï—Å–ª–∏ –≤ operations: [0, 1, 2, 3, 4, 5, 6, 100, 101, 102, 103, 104, 105, 106, 107]
  (–≤—Å–µ–≥–æ 15 –≤ operations)
  
  rank = 7 (–∞–≥–µ–Ω—Ç—ã 0..6 —ç—Ç–æ —Ç–µ —á—Ç–æ —Å—Ç–∞—Ä—à–µ –∏ –≤ operations)
  rank (7) < K (8) ‚Üí ‚úÖ –î–ï–ú–û–£–¢ (8-–π –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É, —Å—Ç–∞—Ä—ã–π!)
  
  –î–µ–º–æ—É—Ç–∏—Ä—É–µ—Ç—Å—è idx=100, —á—Ç–æ –ü–†–ê–í–ò–õ–¨–ù–û (–æ–¥–∏–Ω –∏–∑ 8 —Å—Ç–∞—Ä—ã—Ö)
```

---

## üéØ –ö–õ–Æ–ß–ï–í–û–ô –í–´–í–û–î:

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è:

```
–û–î–ò–ù–ê–ö–û–í–ê–Ø –õ–û–ì–ò–ö–ê –¥–ª—è "oldest first" –∏ "youngest first":

    unsigned int rank = 0u;
    for (unsigned int i in other_agents) {
        if (i < idx) ++rank;  // ‚Üê –û–î–ù–ê –ò –¢–ê–ñ–ï –°–¢–†–û–ö–ê
    }

    if (rank < K):
        // –ê–≥–µ–Ω—Ç –≤ —á–∏—Å–ª–µ K –ø–µ—Ä–≤—ã—Ö –ø–æ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—é
    
–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ö–û–ù–¢–ï–ö–°–¢–ê:

1. –î–ï–ú–û–£–¢ (oldest first):
   - rank = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –°–¢–ê–†–®–ï –º–µ–Ω—è
   - rank < K ‚Üí —è –≤ K —Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö ‚Üí –¥–µ–º–æ—É—Ç–∏—Ä—É—é

2. –ü–†–û–ú–û–£–¢ (youngest first):
   - rank = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –°–¢–ê–†–®–ï –º–µ–Ω—è
   - rank < K ‚Üí —è –≤ K —Å–∞–º—ã—Ö –º–æ–ª–æ–¥—ã—Ö (—Ç.–∫. –µ—Å–ª–∏ –º–∞–ª–æ –∫—Ç–æ —Å—Ç–∞—Ä—à–µ, –∑–Ω–∞—á–∏—Ç —è –º–æ–ª–æ–¥–æ–π)

–ü–û–ß–ï–ú–£ –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢:
- idx –í–°–ï–ì–î–ê –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ mfg_date
- –º–µ–Ω—å—à–∏–π idx = —Å—Ç–∞—Ä—à–µ, –±–æ–ª—å—à–∏–π idx = –º–æ–ª–æ–∂–µ
- –¥–µ–º–æ—É—Ç –±–µ—Ä—ë—Ç K —Å –º–∞–ª—ã–º rank (–º–Ω–æ–≥–æ —Å—Ç–∞—Ä—à–µ) = –°–¢–ê–†–´–ï ‚úÖ
- –ø—Ä–æ–º–æ—É—Ç –±–µ—Ä—ë—Ç K —Å –º–∞–ª—ã–º rank (–º–∞–ª–æ —Å—Ç–∞—Ä—à–µ) = –ú–û–õ–û–î–´–ï ‚úÖ
```

---

## üìä –¢–ï–°–¢ –ù–ê –î–ï–ù–¨ 180 (3650-–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–≥–æ–Ω):

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–µ–º–æ—É—Ç–∞:

```
[DEMOUNT Day 180] AC 24103: rank=0/8 (idx=0, mfg=2281, balance=8)  ‚úÖ –°–¢–ê–†–´–ô
[DEMOUNT Day 180] AC 22607: rank=1/8 (idx=1, mfg=3733, balance=8)  ‚úÖ –°–¢–ê–†–´–ô
[DEMOUNT Day 180] AC 22633: rank=2/8 (idx=2, mfg=3829, balance=8)  ‚úÖ –°–¢–ê–†–´–ô
...
[DEMOUNT Day 180] AC 24479: rank=7/8 (idx=7, mfg=6160, balance=8)  ‚úÖ –°–¢–ê–†–´–ô
[DEMOUNT Day 180] AC XXXXX: rank=8/8 (idx=8, mfg=..., balance=8)   ‚úÖ –ù–ï –î–ï–ú–û–£–¢ (9-–π –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É)
```

**–í–´–í–û–î:** –î–µ–º–æ—É—Ç–∏—Ä—É—é—Ç—Å—è –†–û–í–ù–û —Ç–µ 8 –∞–≥–µ–Ω—Ç–æ–≤ –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–∞—Ä—à–µ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –≤ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö ‚úÖ

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:

–õ–æ–≥–∏–∫–∞ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è –≤ `rtc_quota_ops_excess.py` –ê–ë–°–û–õ–Æ–¢–ù–û –ö–û–†–†–ï–ö–¢–ù–ê:

1. ‚úÖ ETL (build_frames_index) –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç: `idx` –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ `mfg_date`
2. ‚úÖ –ê–≥–µ–Ω—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Å `idx = frame_idx` (–±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)
3. ‚úÖ –î–µ–º–æ—É—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `if (i < idx)` –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ –°–¢–ê–†–®–ï
4. ‚úÖ –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–±–∏—Ä–∞–µ—Ç —Ä–æ–≤–Ω–æ K —Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö
5. ‚úÖ –ü–æ—Ä—è–¥–æ–∫ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
6. ‚úÖ –¢–µ—Å—Ç—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç: –¥–µ–º–æ—É—Ç–∏—Ä—É—é—Ç—Å—è –ü–†–ê–í–ò–õ–¨–ù–´–ï (—Å—Ç–∞—Ä—ã–µ) –∞–≥–µ–Ω—Ç—ã

**–°–¢–ê–¢–£–°:** üü¢ READY FOR PRODUCTION
