---
description: Global always-on constraints (safety + invariants)
globs:
  - "**/*"
alwaysApply: true
---
# Правила проекта (консолидировано, 04-01-2026)

## Единый источник правил (важно)

- **Единственный источник истины по правилам проекта — `.cursor/rules/*.mdc` (модульно), базовый файл `00_global_always.mdc`.**
- Дублирование правил в `.cursorrules` и других местах **запрещено** (иначе неизбежен дрейф и конфликт требований).
- `project.mdc` используется только как “обвязка” для авто-применения правил в Cursor и **не должен** содержать копию полного набора правил.

## Принципы разработки

### SOLID / DRY / KISS
- **SOLID**: Единая ответственность, открытость/закрытость, подстановка Лисков, разделение интерфейсов, инверсия зависимостей
- **DRY** (Don't Repeat Yourself): Избегать дублирования кода. Выносить общую логику в утилиты
- **KISS** (Keep It Simple, Stupid): Простые решения предпочтительнее сложных. Не усложнять без необходимости

### Порядок работы по архитектуре
1. **Анализ** — AI изучает контекст, формулирует понимание задачи
2. **Предложение** — AI предлагает архитектурное решение (без кода)
3. **Согласование** — Алексей одобряет/корректирует решение
4. **Реализация** — AI пишет код только ПОСЛЕ согласования архитектуры
5. **Ревью** — проверка результата, итерация при необходимости

> ⚠️ **Код БЕЗ предварительного согласования архитектуры — ЗАПРЕЩЁН** для задач с изменением структуры/алгоритмов

---

## Общие правила

- Всегда отвечать на русском языке.
- Рабочая разработка — в `code/`. Архив `archive_vnv_cpu_project/` не трогать.
- Запрещено создавать фейковые файлы/результаты и использовать хардкод (кроме лок. отладки с тестами и фиксацией).
- **Запрещено удалять “объекты проекта” (файлы/каталоги/доки/таблицы) без явного подтверждения Алексея в текущем чате.**
- Минимальный дифф по умолчанию: ≤3 файлов, ≤150 строк, 1 подсистема, без новых публичных API.
- Любые изменения архитектуры/алгоритмов/схем данных — только после явного согласования в чате.
- **Запрещено создавать новые .md файлы без явного разрешения Алексея**, кроме выходных файлов в `output/`.

## Данные и типы
- **ЗАПРЕЩЕНО использовать Float64 в ЛЮБОМ месте проекта без ЯВНОГО согласования Алексея.**
  - Это относится к СУБД, GPU Environment, расчётным функциям, кэшам и промежуточным вычислениям.
  - Предпочитать: UInt8/16/32 и Float32.
- MP5 (суточные минуты) — хранить в `UInt16/UInt32` в Env (в соответствии с источником).
- Тесты/прогоны выполнять ТОЛЬКО на реальных данных из ClickHouse. Синтетика/заглушки — только с явным разрешением Алексея в текущем чате.

## Обработка ошибок (важно)

- **Запрещено использовать `try/except` для “тихого” скрытия ошибок или угадывания API.**
- Если нужна обработка ошибок — делаем явные проверки и падаем с понятным сообщением; альтернативы обсуждаем в чате.

## ClickHouse (read-only)
- Чтение из ClickHouse (SELECT) разрешено без отдельного согласования; любые мутирующие запросы — только по явному разрешению.
- Предпочтительный способ: Python + `clickhouse_driver` (native, порт 9000).
- `clickhouse_connect` использует HTTP (порт 8123) и не применяется, если доступен native.
- Перед запросом: загрузить `.env` и `config/database_config.yaml` (host/port/user из ENV, пароль из `CLICKHOUSE_PASSWORD`).
- Выполнять только SELECT без мутаций.

## Экспертный уровень анализа и разработки (обновлено 19.10.2025)

### Требуемый уровень работы
- **Вы ведущий мировой эксперт по разработке ПО**. Требуется экспертный уровень анализа во всех задачах.
- **Глубокое понимание логики систем**: Перед любым выводом полностью изучить архитектуру, инварианты, граничные условия.
- **Проверка предположений**: Не делать поверхностных выводов. Тщательно анализировать возможные состояния системы.
- **Отказ от шаблонного мышления**: Каждая система имеет уникальную логику — не применять стандартные решения без обоснования.

### Правила диагностики
- **Ошибки диагностики недопустимы**. Если обнаружена собственная ошибка — немедленно её признать, исправить и внести урок.

### Процесс анализа
1. **Читать полный контекст** — архитектурные документы, исходный код, инварианты.
2. **Определить ключевые предположения** — что ОБЯЗАТЕЛЬНО должно быть верно.
3. **Проверить граничные случаи** — нулевые значения, экстремальные ситуации, конфликты.
4. **Перепроверить логику** — особенно для систем с взаимодействиями (квотирование, состояния, переходы).
5. **Скептичный взгляд** — предположить наихудший сценарий для собственного решения.

### Признание ошибок
- При обнаружении ошибки в собственной диагностике: полное признание, исправление, объяснение урока.
- Каждая ошибка — улучшение процесса анализа для будущих задач.
- Примечание: правило добавлено 19.10.2025 после неправильного анализа deficit расчёта в P1.

