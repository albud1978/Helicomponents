---
description: Multi-agent workflow (sequential + centralized reporting)
globs:
  - "**/*"
alwaysApply: false
---

# Multi-agent workflow

## Архитектура ролей

```
Пользователь
    ↕ (принципиальные вопросы)
Архитектор (основной агент)
    ↓ бриф → coder-flame → отчёт ↑
    ↓ ревью → reviewer-flame → отчёт ↑
    ↓ валидация → validator-judge → вердикт ↑
```

## Роли

| Роль | Субагент | Репортит |
|------|----------|----------|
| **Архитектор** | основной агент | Пользователю |
| **Кодер** | `coder-flame` | Архитектору |
| **Ревьюер** | `reviewer-flame` | Архитектору |
| **Валидатор** | `validator-judge` | Архитектору |

## Секвентальный workflow

### Этап 1: Планирование
- Пользователь → Архитектор: задача
- Архитектор: декомпозиция, создание плана

### Этап 2: Реализация
- Архитектор → **coder-flame**: бриф на реализацию
- coder-flame → Архитектор: отчёт + код

### Этап 3: Ревью
- Архитектор → **reviewer-flame**: код на ревью
- reviewer-flame → Архитектор: отчёт ревью (критические/замечания/нит)

### Этап 4: Принятие решений
- Архитектор → Пользователь: принципиальные вопросы (если есть)
- Пользователь → Архитектор: решение
- (при необходимости) Архитектор → coder-flame: исправления

### Этап 5: Валидация
- Архитектор → **validator-judge**: код на валидацию
- validator-judge → Архитектор: вердикт PASS/FAIL

### Этап 6: Завершение
- Архитектор: обновление документации
- Архитектор → Пользователь: итоговый результат

## Точки эскалации к Пользователю

Архитектор эскалирует к Пользователю:
- Критические замечания ревьюера (блокируют мердж)
- FAIL от валидатора
- Архитектурные решения с trade-offs
- Выход за scope задачи
- Неоднозначности в требованиях

## Зоны работы субагентов

| Субагент | Зона | Режим |
|----------|------|-------|
| coder-flame | `code/sim_v2/messaging/**`, `code/sim_v2/components/**` | read-write |
| reviewer-flame | весь код | read-only |
| validator-judge | `code/analysis/**`, ClickHouse | read-only |
| Архитектор | `docs/**`, `.cursor/**`, планы | read-write |

## Формат отчёта субагента

После выполнения задачи субагент сдаёт Архитектору:
1. Что сделано
2. Что НЕ трогал
3. Что проверить (1–3 пункта)
4. Риски/вопросы

## Правило разреза

- Один todo = одна подсистема = один субагент = минимальный дифф
- Субагент не меняет файлы вне своей зоны
- Все вопросы — через Архитектора (не напрямую к Пользователю)

## Timeout и отказоустойчивость

- Если субагент не отвечает или зациклился — Архитектор прерывает и эскалирует к Пользователю.
- При сбое субагента — Архитектор фиксирует точку останова, сообщает Пользователю, продолжает после решения.
- Максимум 2 итерации исправлений по замечаниям ревьюера; далее — эскалация к Пользователю.

## Recovery (восстановление)

- При прерывании задачи — Архитектор сохраняет состояние в plan-файле.
- При возобновлении — Архитектор читает plan-файл и продолжает с точки останова.
- Каждый этап workflow фиксируется в plan-файле как checkpoint.

## Context management (передача контекста)

- Между субагентами передаётся только необходимый контекст, не весь накопленный.
- coder-flame получает: бриф + ссылки на файлы.
- reviewer-flame получает: diff изменений + инварианты.
- validator-judge получает: список таблиц + критерии проверки.
- Архитектор агрегирует и фильтрует контекст перед передачей.

## Изменения правил

- Изменения `.mdc`: предлагает субагент → проверяет reviewer-flame → утверждает Архитектор
