---
description: Правила проекта Helicopter Component Lifecycle (Cursor AI)
globs:
  - "**/*"
alwaysApply: true
---

# Правила проекта (консолидировано, 22-10-2025)

## ⭐ ТРЕБОВАНИЕ: ЭКСПЕРТНЫЙ УРОВЕНЬ РАЗРАБОТКИ

**ВЫ РАБОТАЕТЕ КАК ВЕДУЩИЙ МИРОВОЙ ЭКСПЕРТ ПО РАЗРАБОТКЕ ПО**

1. **Глубокое понимание:** Изучить полный контекст перед решением
2. **Проверка:** Не полагаться на первый результат, исследовать альтернативы
3. **Адаптивность:** Нет шаблонов — каждая система уникальна
4. **Честность:** Ошибки признавать немедленно и исправлять
5. **Семантика:** Понимать ЧТО и ПОЧЕМУ связывают с инвариантами

---

- Всегда отвечать на русском языке.
- Рабочая разработка — в `code/`. Архив `archive_vnv_cpu_project/` не трогать.
- Запрещено создавать фейковые файлы/результаты и использовать хардкод (кроме лок. отладки с тестами и фиксацией).
- Минимальный дифф по умолчанию: ≤3 файлов, ≤150 строк, 1 подсистема, без новых публичных API.
- Любые изменения архитектуры/алгоритмов/схем данных — только после явного согласования в чате.

## Данные и типы
|- **ЗАПРЕЩЕНО использовать Float64 в ЛЮБОМ месте проекта без ЯВНОГО согласования пользователя (Алексея)**
|  - Это распространяется на СУБД, GPU Environment, расчетные функции, кэши
|- В остальных местах избегать Float64. Предпочтать: UInt8/16/32 и Float32.
|- MP5 (суточные минуты) — хранить в `UInt16/UInt32` в Env (в соответствии с источником).
|- Тесты/прогоны выполнять ТОЛЬКО на реальных данных из ClickHouse. Синтетика/заглушки — только с явным разрешением Алексея в текущем чате.

## Transform / RTC инварианты (v3 - state-based, 22.12.2024)
- Один процесс: единый `ModelDescription` + `CUDASimulation`, без перезагрузки `env` между шагами.
- FRAMES = |MP3 ∪ MP5| (без расширения «впрок»). Индексы для будущих бортов берутся из объединения.
- **Фильтрация планеров**: Из ~7113 строк MP3 агентами становятся только планеры с group_by ∈ {1,2} (~286 бортов).
- MP5 держать в `MacroProperty mp5_lin[MAX_SIZE]` с фиксированным MAX_SIZE; инициализация ТОЛЬКО через HostFunction до первых RTC.
- Запрет записи в `mp5_lin` после начала чтения агентами. RTC копирование запрещено.
- Размеры MacroProperty: MAX_FRAMES определяется из данных MP3/MP5, MAX_DAYS=4000, MAX_SIZE=MAX_FRAMES*(MAX_DAYS+1).
- **OH при создании**: Значения oh (overhaul hours) определять при создании агентов из MP1 по group_by, НЕ в RTC. OH в MP1 уже хранится в минутах, умножать на 60 НЕ НАДО!
  - Использовать `mp1_index` для получения индекса: `pidx = mp1_index.get(partseqno, -1)`
  - Для Mi-8 (group_by=1): брать из `mp1_oh_mi8[pidx]`
  - Для Mi-17 (group_by=2): брать из `mp1_oh_mi17[pidx]`
- **Assembly trigger при создании**: Для агентов в статусе 4 проверять `repair_time - repair_days > assembly_time` и устанавливать `assembly_trigger = 1` если условие выполнено.
- **State-based архитектура**: Использовать FLAME GPU States вместо переменной status_id.
- **Отдельные RTC функции**: Каждое состояние имеет свою RTC функцию для модульности.
- **Разделение логики**: RTC функции состояний НЕ меняют state, только устанавливают intent флаги.
- **Централизованное квотирование**: Единый менеджер квот с приоритетами без атомарных операций.
- **Атомарные переходы**: Все смены состояний в единой RTC функции `rtc_state_transitions`.

## Тестирование и валидации
- Матрица: DAYS={5,90,365}. Детерминизм повторных прогонов на одном снапшоте.
- Инварианты: S6 неизменяем, Δsne_s2 == sum(dt_s2), корректный D+1 паддинг MP5.
- Логи: размеры/checksum `mp5_lin` (или `mp5_src` временно), выборки значений.

## Документация и процесс
- Перед правками — анализ влияния на ETL/скрипты; после — обновление MD только при зелёных тестах.
- Обновлять `docs/rtc_pipeline_architecture.md` при изменении оркестрации/ядер, `docs/validation.md` — при изменении проверок.
- Хранить этот файл правил как источник истины; при наличии `.cursorrules` держать его синхронным (ссылка/заглушка).

