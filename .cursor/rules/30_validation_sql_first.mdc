---
description: Validation discipline (DB-first, SQL invariants)
globs:
  - "code/analysis/sim_validation_*.py"
  - "docs/validation.md"
alwaysApply: false
---

# Validation (SQL-first)

- Истина — данные в СУБД после MP2.
- Логирование в RTC добавляется только по явному согласованию и удаляется после фикса.
- Критерий успеха: инварианты подтверждены SQL (0 нарушений).

## Приоритет валидации
- Основной контроль: итоговая выгрузка в СУБД через MP2.
- Удаление логов после фикса: обязательно + повторное тестирование.

## Риски логирования в RTC ядрах
- Race conditions (конкурентная запись от тысяч потоков)
- Сбои компиляции NVRTC
- Ограничения FLAME GPU
- Производительность (логирование может замедлить симуляцию в десятки раз)

## Матрица тестов
- DAYS={5,90,365,3650}. Детерминизм повторных прогонов на одном снапшоте.
- Для валидации модулей: полный прогон на 3650 дней (все ядра скомпилированы).

## Инварианты
- S6 неизменяем, Δsne_s2 == sum(dt_s2), корректный D+1 паддинг MP5.
- Все проверки инвариантов выполняются SQL-запросами к СУБД.

## Валидация данных heli_pandas
- Документация: `docs/data_validation.md`
- Скрипт: `code/analysis/validate_heli_pandas.py`
- Колонки: ll_mi8, oh_mi8, br_mi8 (из md_components), error_flags (битовая маска ошибок)
- Статусы ошибок (10–15): проверяются параллельно, без вложенности
  - S10: ll = 0 или NULL
  - S11: target_date < version_date
  - S12: condition != 'ИСПРАВНЫЙ' AND sne = 0
  - S13: sne > ll OR ppr > oh
  - S14: condition NOT IN ('ИСПРАВНЫЙ', 'НЕИСПРАВНЫЙ', 'ДОНОР', 'ВОЗМОЖНОЕ ПРОДЛЕНИЕ НР')
  - S15: condition = 'ДОНОР' AND sne < br (warning)
- Рабочие статусы (1–6): назначаются только если error_flags = 0

## Подход к дебагу логики
- Начинать с фактов из СУБД/MP2, не с гипотез.
- Проверять индексы дня: `current_day`, `prev_day`, `target_day`, `write_day`, `safe_day`.
- Сверять порядок слоёв и точку истины для счётчиков (post‑quota vs pre‑quota).
- Минимальный дебаг: явные счётчики (ops/target/need/used) в MP2/MP‑буферы; удалить после фикса.
- При падениях RTC сначала проверить наличие env‑констант/Property/MacroProperty и их типы.
- Для расхождений — срез одного дня: сравнить состояния/ключевые переменные с baseline на том же дне.
